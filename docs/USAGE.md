# üìò Pi-hole Latency Stats (PHLS) v4.0 - Technical Manual

**Version:** 4.0

**Release Date:** 2026-01-06

**Architecture:** Profile-Based / Historical Monitoring

---

## üìë Table of Contents

1. **[Introduction & Architecture](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#1-introduction--architecture)**
2. **[Directory Structure](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#2-directory-structure)**
3. **[The Core Script (`pihole_stats.sh`) - Deep Dive](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#3-the-core-script-pihole_statssh---deep-dive)**
   * [CLI Arguments & Flags](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#cli-arguments--flags)
   * [Output Modes & Formats](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#output-modes--formats)
   * [Unbound Integration & Cache Counting](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#unbound-integration--cache-counting)
   * [Safety Mechanisms (Locking & Snapshots)](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#safety-mechanisms-locking--snapshots)


4. **[The Profile System & Automation](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#4-the-profile-system--automation)**
   * [Concept: What is a Profile?](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#concept-what-is-a-profile)
   * [Using the Cron Maker (TUI)](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#using-the-cron-maker-tui)
   * [MANUAL Profile Configuration (Advanced)](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#manual-profile-configuration-advanced)


5. **[Configuration File Anatomy (`pihole_stats.conf`)](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#5-configuration-file-anatomy-pihole_statsconf)**
6. **[The Dashboard v2.0](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#6-the-dashboard-v20)**
   * [Access & URL Parameters](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#access--url-parameters)
   * [Metrics & Visualization](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#metrics--visualization)
   * [Gap Filling & Stale Data Logic](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#gap-filling--stale-data-logic)


7. **[Metric Definitions (The Analytics)](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#7-metric-definitions-the-analytics)**
8. **[Update Notifications & Maintenance](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#8-Update-Notifications-&-Maintenance)**
   * [The Unistaller](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#%EF%B8%8F-the-uninstaller)
   
10. **[Troubleshooting & Debugging](https://github.com/panoc/pihole-latency-stats/blob/main/docs/USAGE.md#9-troubleshooting--debugging)**

---

**PHLS v4.0** is a comprehensive monitoring suite for Pi-hole and Unbound. Unlike basic "snapshot" tools, PHLS is designed for **historical analysis**. It records data over time to help you identify:

* **Latency Spikes:** Is your ISP lagging at 8 PM?
* **Jitter:** Is your connection fast but unstable?
* **Cache Efficiency:** Is Unbound actually holding records in RAM?

It consists of three components working in tandem:

1. **Core Script:** A Bash script that queries the Pi-hole FTL database and Unbound control socket.
2. **Cron Maker:** A Terminal UI (TUI) tool to manage automated monitoring schedules (down to 10-second intervals).
3. **Dashboard:** A browser-based visualization tool that reads the data generated by the core script.

---

## 1. Introduction & Architecture

**Pi-hole Latency Stats v4.0** is a complete rewrite of the original tool. Unlike previous versions which were "stateless" (showing only a snapshot of the *now*), v4.0 is a **stateful monitoring system**.

### Key Architectural Changes:

* **Profile-Awareness:** The script no longer assumes a single global configuration. It can switch "personalities" (Profiles) to monitor different things (e.g., one profile for Upstream latency, another for local Network latency).
* **Time-Series Data:** It maintains history files (`.h.json`) allowing for long-term trend analysis (12h, 24h, 7d, 30d).
* **Concurrency Locking:** Uses PID lock files (`/tmp/phls_<profile>.lock`) to prevent Cron jobs from overlapping and spiking CPU usage.
* **Sub-Minute Resolution:** The new Cron Maker enables monitoring intervals as fast as **10 seconds** using sleep-loop injection.

---

## 2. Directory Structure

### Directory Structure

Understanding where files live is crucial for advanced configuration.

* **`~/phls/`** (Root Directory)
* `pihole_stats.sh`: The brain. Runs queries and generates reports.
* `pihole_stats.conf`: Default configuration file.
* `profiles.db`: A registry linking Profile Names -> Config File Paths.


* **`~/phls/cron/`**
* `cronmaker.sh`: The TUI tool for managing schedules.
* `cron_profiles.db`: Database of active cron schedules.


* **`/var/www/html/admin/img/dash/`** (Web Directory)
* `dash.html`: The frontend visualization.
* `dash_default.json`: The latest snapshot data.
* `dash_default.h.json`: The historical dataset (can grow large).



---

## 3. The Core Script (`pihole_stats.sh`)

Usage: `sudo ./pihole_stats.sh [FLAGS]`

### CLI Arguments & Flags

#### **Query Modes (What to analyze)**

* **(Default):** Analyzes all valid queries (Forwarded + Cached).
* `-up`: **Upstream Only**. filters for `status IN (2, 6, 7, 8)`. Use this to test your ISP/External DNS latency.
* `-pi`: **Pi-hole Only**. Filters for `status IN (3, 12, 13, 14, 15)`. Use this to test internal processing speed/cache lookup speed.
* `-nx`: **Exclude Blocked**. Removes `0.0ms` blocked queries from the average calculation. Essential for "real" browsing latency stats.

#### **Filtering (Narrowing the scope)**

* `-dm "string"`: **Wildcard Filter**. Matches any domain containing the string (SQL `LIKE '%string%'`).
* *Example:* `-dm "google"` matches `google.com`, `drive.google.com`.


* `-edm "domain"`: **Exact Domain**. Matches the specific domain or its subdomains explicitly (SQL `LIKE 'domain' OR LIKE '%.domain'`).
* *Example:* `-edm "netflix.com"` matches `netflix.com` and `api.netflix.com`.


* `-24h` / `-7d`: Quick presets for the time window.
* `-from "date"` / `-to "date"`: Custom window. Accepts any format `date` understands (e.g., "yesterday", "2 hours ago").

#### **Dashboard & History Management**

* `-dash [name]`: **Trigger Dashboard Mode**.
* Generates `dash_[name].json` (Snapshot) and appends to `dash_[name].h.json` (History).
* *Note:* This implies `-j` (JSON output) and `-s` (Silent).


* `-nh`: **No History**. Updates the snapshot but **skips** appending to the history file. Useful for testing a profile without corrupting your long-term graph.
* `-clear`: **Wipe History**. Deletes the `.h.json` file for the specified profile.

### Unbound Integration & Cache Counting

* `-unb`: Force enable standard Unbound stats (Hit Ratio, Prefetch).
* `-ucc`: **Unbound Cache Count (Deep Inspection)**.
* **Command:** Runs `unbound-control dump_cache`.
* **Mechanism:** Parses the raw dump to count `msg` (Messages/Questions) and `rrset` (Resource Records/Answers).
* **‚ö†Ô∏è Performance Warning:** Dumping the cache **locks** Unbound's memory. On a Pi Zero with 50k+ entries, this can pause DNS resolution for 1-3 seconds. Use sparingly (e.g., hourly), NOT every 10 seconds.
> **In order -unb and -ucc to work you need to add in your unbound.conf :**

```
server:
  ... other settings ...
  extended-statistics: yes

remote-control:
  control-enable: yes
  control-interface: 127.0.0.1
```


### üìÑThe Core Script (`pihole_stats.sh`) - Deep Dive

Control where and how the data is displayed or saved.

| Flag | Description |
| --- | --- |
| `-j` | **JSON Mode.** Outputs raw JSON. Essential for the dashboard or external tools (Grafana/Node-RED). |
| `-f "file"` | **File Output.** Saves the text report to the specified filename. |
| `-s` | **Silent Mode.** Suppresses all terminal output (Spinners, Text Reports). *Mandatory for Cron jobs.* |
| `-seq` | **Sequential Naming.** If the target file exists, appends a number (e.g., `stats_1.json`, `stats_2.json`). |
| `-ts` | **Timestamp Naming.** Appends the current date/time to the filename (e.g., `stats_2023-10-25_1400.json`). |
| `-hor` | **Horizontal Layout.** Forces the "Split Pane" text report (ideal for wide terminals). |
| `-ver` | **Vertical Layout.** Forces the "List View" text report (ideal for mobile or logs). |

### üîç Query Filters & Modes

Determine *which* DNS queries are included in the math.

| Flag | Description |
| --- | --- |
| **(Default)** | Analyzes all valid queries (Forwarded + Cached). |
| `-up` | **Upstream Mode.** Filters for `status IN (2, 6, 7, 8)`. Analyzes **only** queries sent to the internet (Google, Cloudflare, Unbound). Use this to benchmark your ISP/DNS Provider. |
| `-pi` | **Pi-hole Mode.** Filters for `status IN (3, 12, 13, 14, 15)`. Analyzes **only** cached or local answers. Use this to benchmark your Pi's hardware speed. |
| `-nx` | **Exclude Blocked.** Removes Blocked (0.0ms) queries from the dataset. This prevents "Gravity" blocks from artificially lowering your average latency. |
| `-dm "text"` | **Wildcard Filter.** Matches any domain containing "text" (e.g., `-dm "google"` matches `google.com` and `drive.google.com`). |
| `-edm "domain"` | **Exact Match.** Matches only the specific domain (e.g., `-edm "netflix.com"`). |

### üïí Time & Date Filters

Define the window of analysis.

| Flag | Description |
| --- | --- |
| `-24h` | Analyzes the last 24 hours. |
| `-7d` | Analyzes the last 7 days. |
| `-<N>h` | Analyzes the last N hours (e.g., `-12h`). |
| `-<N>d` | Analyzes the last N days (e.g., `-30d`). |
| `-from "X"` | Starts analysis from a specific date. Accepts natural language (e.g., `-from "yesterday"`, `-from "2023-01-01"`). |
| `-to "X"` | Ends analysis at a specific date (e.g., `-to "2 hours ago"`). |

### üåç Unbound Integration Flags

Specific controls for the Unbound Recursive DNS server.

| Flag | Description |
| --- | --- |
| `-unb` | **Force Enable.** Appends Unbound stats (Hits, Misses, Memory) to the report. (Script usually auto-detects this). |
| `-unb-only` | **Unbound Only.** Skips all Pi-hole database analysis. Runs *only* the Unbound check. Instant execution. |
| `-no-unb` | **Disable.** Forces the script to ignore Unbound, even if present. |
| `-ucc` | **Cache Count (Deep).** Performs a `dump_cache` command to count the exact number of **Messages** and **RRsets** in RAM. *Warning: Can cause a 1-second pause on large caches.* |

### üìä Dashboard & History Flags

These flags manage the **Profile System** and data retention.

| Flag | Description |
| --- | --- |
| `-dash "name"` | **Dashboard Mode.** Runs the analysis for the specific profile "name". Updates `dash_name.json` (Snapshot) and appends to `dash_name.h.json` (History). |
| `-nh` | **No History.** Updates the snapshot file but **skips** writing to the history file. Use this for testing changes without corrupting your long-term graphs. |
| `-clear` | **Clear History.** Deletes the history file (`.h.json`) for the current profile. |
| `-rt "days"` | **Retention Policy.** Deletes text/json files in the output directory that are older than "days". |

### üõ†Ô∏è Advanced & Debug Flags

Low-level controls for power users.

| Flag | Description |
| --- | --- |
| `-snap` | **Snapshot Mode.** Creates a backup of the Pi-hole database (`/tmp/pi_snap_*.db`) before reading. Prevents "Database Locked" errors. Auto-detects if RAM (`/dev/shm`) is available for faster processing. |
| `-c "file"` | **Load Config.** Load a specific configuration file instead of the default. |
| `-mc "file"` | **Make Config.** Generates a fresh configuration file at the specified path. |
| `-db "path"` | **Manual DB.** Force the script to read a specific SQLite database file instead of `/etc/pihole/pihole-FTL.db`. |
| `-debug` | **Debug Mode.** Enables verbose logging to `pihole_stats_debug.log`. Prints every variable and decision made by the script. |

---

### Safety Mechanisms (Locking & Snapshots)

* **PID Locking:** The script creates `/tmp/phls_[profile].lock`.
* *Scenario:* You schedule a check every 10 seconds. The Pi slows down, and a check takes 15 seconds.
* *Result:* The next scheduled run sees the `.lock` file, detects the previous process is still alive (`kill -0`), and aborts immediately. This prevents "cron pile-ups" that crash the CPU.


* **Snapshot Mode (`-snap`):**
* *Scenario:* Pi-hole's FTL database is locked by a long-term query.
* *Action:* PHLS creates a temporary copy (`sqlite3 .backup`) to `/tmp/pi_snap_XXXX.db`.
* *Smart RAM:* If free RAM > DB Size + 50MB, it creates the snapshot in RAM (`/dev/shm` or equivalent) for speed. Otherwise, it uses Disk.



---

## 4. The Profile System & Automation

### Concept: What is a Profile?

A Profile allows you to run multiple independent monitors.

* **Profile A ("default"):** Standard 1-min checks.
* **Profile B ("gaming"):** Checks `steam.com` latency every 10 seconds.

Each profile gets:

1. A config file: `~/phls/<name>/pihole_stats.conf`
2. A dashboard URL: `dash.html?p=<name>`
3. A unique lock file.

### Using the Cron Maker (TUI)

Run: `sudo ~/phls/cron/cronmaker.sh`

1. **Create Profile:**
* Enter a name (alphanumeric).
* **Customize Tiers:** The TUI will ask if you want to edit latency buckets. This allows you to set "Tier 1" to "0.5ms" for a local LAN profile, or "20ms" for a WAN profile.
* **Extra Arguments:** Enter standard CLI flags here (e.g., `-up -nx`).
* **Schedule:**
* Standard: Input a number (Minutes).
* **Sub-Minute:** Run with `cronmaker.sh -s` to unlock Seconds. Options: 10, 15, 20, 30.
* *How Sub-Minute Works:* It generates multiple cron entries with `sleep X;` commands.
* *Example (Every 30s):*
```cron
* * * * * ./script.sh ...
* * * * * sleep 30; ./script.sh ...

```







### MANUAL Profile Configuration (Advanced)

If you hate interactive wizards, you can build profiles manually.

**Step 1: Create Directory**

```bash
mkdir -p ~/phls/my_custom_profile

```

**Step 2: Create Configuration**
Copy the default config or create a new one:

```bash
cp ~/phls/pihole_stats.conf ~/phls/my_custom_profile/pihole_stats.conf

```

**Step 3: Edit Configuration**
Edit `~/phls/my_custom_profile/pihole_stats.conf`. You **must** set specific variables (see Section 5 below) if you want to override defaults. specifically `CONFIG_ARGS`.

**Step 4: Register (Optional)**
You don't *have* to register it in `profiles.db` if you call it by path, but to use it nicely with `-dash my_custom_profile`, add it:

```bash
echo "my_custom_profile|~/phls/my_custom_profile/pihole_stats.conf" >> ~/phls/profiles.db

```

**Step 5: Test**

```bash
sudo ./pihole_stats.sh -c ~/phls/my_custom_profile/pihole_stats.conf

```

---

## 5. Configuration File Anatomy

The `pihole_stats.conf` file allows you to set permanent defaults so you don't have to type flags every time.

```bash
# ================= PI-HOLE STATS CONFIGURATION =================

# --- Database Location ---
# Path to your Pi-hole FTL database.
DBfile="/etc/pihole/pihole-FTL.db"

# --- Output Directories ---
# Default directories for manual reports (using -j or -f).
# Leave empty "" to save in the current directory.
SAVE_DIR_TXT=""
SAVE_DIR_JSON=""

# --- DEFAULT FILENAMES --- 
TXT_NAME="stats.txt"
JSON_NAME="stats.json"

# --- Dashboard Settings ---
# Directory where the web dashboard files are stored.
DASH_DIR="/var/www/html/admin/img/dash"

# Max entries for history graphs (8640 = 30 days at 5min intervals).
MAX_HISTORY_ENTRIES="8640"

# --- Auto-Delete ---
# Delete reports older than X days (leave empty to disable).
MAX_LOG_AGE=""

# --- Unbound Integration ---
# auto  : Check if Unbound is running.
# true  : Always show Unbound stats.
# false : Never show Unbound stats.
ENABLE_UNBOUND="auto"

# --- Visual Layout for CLI ---
# auto       : Detects terminal width.
# vertical   : Standard list view.
# horizontal : Split-pane view.
LAYOUT="auto"

# --- Default Time Range ---
# Optional: Set a default lookback period (e.g., "yesterday", "today 00:00").
# CLI flags like -24h will override this.
DEFAULT_FROM=""
DEFAULT_TO=""

# --- HARD ARGUMENTS ---
# Any flags placed here are injected into the script automatically.
# This is how Profiles are differentiated (e.g., Profile A has CONFIG_ARGS='-up', Profile B has '-pi').
CONFIG_ARGS=""

# --- Latency Tiers (Upper Limits in Milliseconds) ---
# These values (in milliseconds) define the "Tiers" shown in the distribution graph.
# You can customize these to match your network expectations.
L01="0.009"
L02="0.1"
L03="1"
L04="10"
L05="50"
# ... up to L20 ...
L10="1000"   # Timeout / Packet Loss

# --- Latency Cutoffs ---
# Ignore queries faster than MIN or slower than MAX (in milliseconds).
# Useful to exclude cached (0.1ms) or timeouts.
MIN_LATENCY_CUTOFF=""
MAX_LATENCY_CUTOFF=""

```


---

## 6. The Dashboard v2.0

### Access & URL Parameters

* **Default:** `http://<ip>/admin/img/dash/dash.html`
* **Specific Profile:** `...?p=upstream_check`
* Loads `dash_upstream_check.json` and `dash_upstream_check.h.json`.



### Metrics & Visualization

1. **Latency History:**
* **Line/Bar Chart:** Shows Average (Blue) vs P95 (Orange).
* **Controls:** Click `Log` (Logarithmic) to flatten huge spikes. Click `Scroll` (‚Üî) to pan through history if data > screen width.


2. **Standard Deviation:**
* Shows the stability of the connection.
* *High Avg / Low StdDev:* Consistently slow.
* *Low Avg / High StdDev:* Fast but jittery/unstable (Gamers hate this).


3. **Unbound Efficiency:**
* Tracks **Hits** (Cyan) vs **Misses** (Red).
* Look for a high "Prefetch" ratio (Green line) ‚Äì this means Unbound is updating records *before* they expire.


4. **Memory:**
* Visualizes `msg.cache` vs `rrset.cache`. If this hits 100%, Unbound will start evicting records early.



### Gap Filling & Stale Data Logic

The JS engine includes a **Gap Detection Algorithm**.

* **Stale Data:** If the last update in the JSON is older than `3x` the median update interval, the dashboard shows a "DATA STALE" warning in the header.
* **Gap Filling:** If the chart detects a missing chunk of time (e.g., Pi was off for 2 hours), it inserts "null" gaps in the graph rather than drawing a straight line across the outage.

---

## 7. Metric Definitions (The Analytics)

* **Average (Mean):** Total Duration / Total Queries. Good for general health.
* **Median (P50):** The exact middle query. 50% were faster, 50% slower. Ignores outliers.
* **95th Percentile (P95):** The "Worst Case" for normal use. 95% of queries were faster than this. If P95 is high (e.g., 500ms) but Average is low (20ms), you have occasional massive lag spikes (packet loss).
* **Standard Deviation:** Calculated using the Sum of Squares.
* `SQRT( (Sum(time^2) / count) - (avg^2) )`.
* Measures "Jitter". Ideally, should be close to 0.

---

## 8. Update Notifications & Maintenance

PHLS v4.0 includes a "Version Check" system. It keeps you informed about new features or fixes without automatically modifying your system files.

### üîÑ The Update Checker
The installer deploys a lightweight background check script named `phls_version_check.sh`.

* **Location:** `~/phls/phls_version_check.sh`
* **Schedule:** Runs automatically every **3 days** (via Cron).
* **How it works:**
    1.  It downloads a tiny `version` file from the official repository to your local folder.
    2.  It **does not** download or change any code. It only updates the version definition file.
    3.  This ensures your customizations are never overwritten automatically.

### üîî How you get notified
Since the system doesn't auto-upgrade, it uses the `version` file to alert you in two places:

1.  **Terminal (CLI):**
    Every time you run `pihole_stats.sh`, it compares its internal version against the downloaded `version` file.
    * *If an update exists:* You will see a bright **[NEW UPDATE AVAILABLE]** banner at the bottom of your output with a link to the release.

2.  **Dashboard:**
    The dashboard checks the `version` file every time it loads.
    * *If an update exists:* An notification link (e.g., `(NEW v4.1)`) will appear in the footer next to the version number.

### ‚ö° How to Upgrade
When you see a notification, you update the system manually by running the installer command again. It detects your existing setup and performs a "Safe Upgrade" (keeping your config and history intact).

```bash
curl -sL [https://github.com/panoc/pihole-latency-stats/releases/latest/download/install_phls.sh](https://github.com/panoc/pihole-latency-stats/releases/latest/download/install_phls.sh) | sudo bash

```

### üóëÔ∏è The Uninstaller

The project includes a dedicated uninstaller generated during installation. This ensures a clean removal of all components, including hidden cron jobs and temporary files.

* **Location:** `~/phls/phls_uninstall.sh`
* **How to Run:**
```bash
sudo ~/phls/phls_uninstall.sh

```


* **What it Removes:**
* The `~/phls/` directory and all scripts.
* The Dashboard files from the web server directory.
* **All Cron Jobs:** It scans your crontab and removes every entry associated with PHLS (including sub-minute sleep loops).
* **Databases:** Removes the profile registry and history files.



> **‚ö†Ô∏è Warning:** Running the uninstaller **permanently deletes** your historical latency data (`.h.json` files). If you wish to keep your data, backup the `json` files before running this script.

```

### Summary of Changes made based on the code:
1.  **Correction:** Clarified that `phls_version_check.sh` only downloads the `version` file, it does *not* download the code.
2.  **Correction:** Defined the "Notification" flow. `pihole_stats.sh` reads the local file to print the banner, it doesn't check the internet itself (making it faster/safer).
3.  **Upgrade Path:** Added the instruction that the user must run the installer again to actually apply the update.

```

## 9. Troubleshooting & Debugging

**Problem: Cron job creates pile-ups / CPU 100%.**

* **Fix:** Ensure `check_lock` is working. Check `/tmp/phls_<name>.lock`.
* **Fix:** Use `-snap`. Queries on the live FTL db can stall if FTL is writing logs.

**Problem: Unbound stats are all zero or "Permission Denied".**

* **Cause:** The user running the script (e.g., `pi`) cannot talk to the Unbound control socket.
* **Fix:** Run with `sudo`. The installer sets up Cron jobs as root for this reason.
* **Cause:** `unbound-control` is not set up. Run `sudo unbound-control-setup`.

**Problem: Memory Charts are empty.**

* **Cause:** Unbound "Extended Statistics" are off.
* **Fix:** Add `extended-statistics: yes` to `/etc/unbound/unbound.conf`.

**Problem: "Database Locked" in logs.**

* **Fix:** This happens when Pi-hole rotates logs or does heavy writes. **Always use `-snap` in profiles running frequently (< 1 min).**

**Problem: Dashboard shows "Profile Default" but I want "Gaming".**

* **Fix:** You must modify the URL manually: `dash.html?p=gaming`. There is no menu in the dashboard to switch profiles yet; you must know the name.
