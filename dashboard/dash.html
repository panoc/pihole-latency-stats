<!DOCTYPE html>
<html lang="en">
<head>
/* v3.5*/
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi-hole Latency Stats Dashboard</title>
    
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png?v=3">

    <link href="bootstrap.min.css" rel="stylesheet">
    <script src="chart.js"></script>
    
    <style>
        /* --- THEME PALETTE & CONFIG --- */
        :root {
            /* --- ðŸ”§ CONFIGURATION VARIABLES --- */
            --page-width:   1080px;  
            --chart-height: 430px;   

            /* Colors */
            --text-main:   #e0e0e0;   
            --text-bright: #e6dfdf;   
            --text-muted:  #b0b0b0;   
            
            --bg-card:     #1f2226;   
            --border-color:#343a40;   
            
            --acc-green:   #00a65a;
            --acc-blue:    #3c8dbc;
            --acc-vibrant: #4aa3df;
            --acc-yellow:  #f39c12;
            --acc-red:     #dd4b39;
        }

        body { 
            background-image: linear-gradient(120deg, #420808, #1a1a1a);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            color: var(--text-main);
            padding-top: 10px; 
            padding-bottom: 5px; /* Minimal bottom padding */
            font-family: 'Source Sans Pro', 'Segoe UI', Helvetica, Arial, sans-serif;
            font-size: 0.9rem; 
        }

        /* Container uses variable */
        .container {
            max-width: var(--page-width) !important;
        }

        .card { 
            background-color: var(--bg-card); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            border: none;
            border-top: 3px solid var(--border-color); 
            margin-bottom: 12px; 
            border-radius: 4px; 
        }

        /* Compact Header */
        .card-header { 
            background-color: rgba(255,255,255,0.02); 
            border-bottom: 1px solid var(--border-color); 
            font-weight: 600; 
            color: var(--text-bright); 
            font-size: 1rem;
            letter-spacing: 0.5px;
            padding: 8px 15px; 
        }

        .card-body {
            padding: 8px 15px; 
        }

        /* --- COMPACT STAT ROWS --- */
        .stat-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 4px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            min-height: 32px; 
        }
        .stat-row:last-child { border-bottom: none; }

        .stat-label { color: var(--text-main); font-weight: 400; flex-grow: 1; font-size: 0.95rem; }
        
        .stat-data-container { display: flex; align-items: center; justify-content: flex-end; width: 160px; }
        .stat-value { font-weight: 700; color: var(--text-bright); font-variant-numeric: tabular-nums; font-size: 1rem; width: 60px; text-align: right; }
        .badge-sub { font-size: 0.8em; color: var(--text-muted); width: 70px; text-align: right; margin-left: 5px; font-weight: normal; }

        .progress { background-color: #2c3036; margin-top: 4px; margin-bottom: 4px; } 
        .progress-micro { height: 5px; border-radius: 4px; }

        .bg-secondary { background-color: #343a40 !important; color: #fff; }
        .bg-primary { background-color: var(--acc-blue) !important; }
        .bg-success { background-color: var(--acc-green) !important; }
        .bg-danger { background-color: var(--acc-red) !important; }
        .text-muted { color: var(--text-muted) !important; }
        
        h3 { color: var(--text-bright); font-weight: 300; margin-bottom: 0; font-size: 1.5rem; }
        hr { border-top-color: var(--border-color); opacity: 0.5; margin: 0.4rem 0; }

        #refreshTimer { font-family: monospace; opacity: 0.7; font-size: 0.85em; margin-right: 15px; color: var(--text-main); }
        
        .header-logo-svg { height: 32px; width: auto; margin-right: 12px; vertical-align: middle; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3)); }
        
        .header-wrapper { position: relative; display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.5rem; padding-top: 0; }
        .header-center-absolute { 
            position: absolute; left: 50%; bottom: 5px; transform: translateX(-50%); 
            text-align: center; white-space: nowrap; 
        }

        #profile-container { margin-bottom: 8px; display: none; }
        .profile-text { font-weight: 600; color: var(--text-bright); font-size: 1rem; letter-spacing: 0.5px; padding-left: 2px; }

        /* Chart uses variable */
        .chart-container { height: var(--chart-height); position: relative; } 
        
        /* FIX: Remove bottom margin from chart card to pull footer up */
        .chart-card-padding { 
            padding: 10px !important; 
            margin-bottom: 0 !important; /* Zero margin at bottom */
        }

        /* Small Text Helper */
        .txt-small { font-size: 0.85rem; }

        /* Footer Styling (Ultra Compact) */
        footer { 
            margin-top: 0;       /* No gap above footer */
            margin-bottom: 5px;  /* Tiny gap at bottom of screen */
            font-size: 0.85rem; 
            opacity: 0.7; 
        }
        
        /* Tight separator line */
        footer hr {
            margin-top: 5px;
            margin-bottom: 5px;
            opacity: 0.2;
        }
        
        footer a { color: var(--text-muted); text-decoration: none; transition: color 0.2s; border-bottom: 1px dotted rgba(255,255,255,0.2); }
        footer a:hover { color: var(--text-bright); border-bottom-color: var(--text-bright); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header-wrapper">
        <div class="d-flex align-items-center">
            <svg class="header-logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <rect x="10" y="50" width="18" height="50" rx="2" fill="#3c8dbc"/>
                <rect x="32" y="30" width="18" height="70" rx="2" fill="#00a65a"/>
                <rect x="54" y="45" width="18" height="55" rx="2" fill="#f39c12"/>
                <rect x="76" y="70" width="18" height="30" rx="2" fill="#dd4b39"/>
                <path d="M41 30 Q30 10 20 25 Q30 35 41 30 Z" fill="#00a65a"/>
                <path d="M41 30 Q52 10 62 25 Q52 35 41 30 Z" fill="#00a65a"/>
            </svg>
            <h3 id="main-title">Pi-hole Latency Stats Dashboard</h3>
        </div>

        <div class="header-center-absolute">
            <small class="text-muted" id="header_date">Loading...</small>
        </div>

        <div class="text-end pb-1">
            <span id="refreshTimer">Auto-refresh in 60s</span>
            <span class="badge bg-secondary" id="time_period">--</span>
            <span class="badge bg-primary" id="query_mode">--</span>
        </div>
    </div>

    <div id="profile-container">
        <div class="profile-text" id="profile-indicator"></div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card h-100" style="border-top-color: var(--acc-blue);">
                <div class="card-header">Pi-hole Performance</div>
                <div class="card-body">
                    <div class="stat-row">
                        <span class="stat-label">Total Queries</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="p_total">--</span>
                            <span class="badge-sub"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Unsuccessful</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="p_invalid">--</span>
                            <span class="badge-sub" id="p_invalid_pct"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Valid</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="p_valid">--</span>
                            <span class="badge-sub"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Blocked</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="p_blocked">--</span>
                            <span class="badge-sub" id="p_blocked_pct"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Analyzed</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="p_analyzed">--</span>
                            <span class="badge-sub" id="p_analyzed_pct"></span>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center mt-3">
                        <div class="col-4 border-end border-secondary">
                            <div class="text-muted small" style="font-size:0.8em">AVERAGE</div>
                            <div class="h4 mb-0" style="color: var(--acc-vibrant);" id="p_avg">--</div>
                        </div>
                        <div class="col-4 border-end border-secondary">
                            <div class="text-muted small" style="font-size:0.8em">MEDIAN</div>
                            <div class="h4 mb-0" style="color: var(--text-bright);" id="p_med">--</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small" style="font-size:0.8em">95th %</div>
                            <div class="h4 mb-0" style="color: var(--acc-yellow);" id="p_95">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100" style="border-top-color: var(--acc-green);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Unbound Performance</span>
                    <div>
                        <span class="text-muted small me-2">Status:</span>
                        <span id="u_status_badge" class="badge bg-secondary">Checking...</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="stat-row">
                        <span class="stat-label">Total Queries</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="u_total">--</span>
                            <span class="badge-sub"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cache Hits</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="u_hits">--</span>
                            <span class="badge-sub" id="u_hit_pct"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cache Misses</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="u_miss">--</span>
                            <span class="badge-sub" id="u_miss_pct"></span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Prefetch Jobs</span>
                        <div class="stat-data-container">
                            <span class="stat-value" id="u_pre">--</span>
                            <span class="badge-sub" id="u_pre_pct"></span>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-6 border-end border-secondary">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="stat-label">Msg Cache</span>
                                <span class="txt-small text-bright" id="mem_msg_txt">-- / --</span>
                            </div>
                            <div class="progress progress-micro">
                                <div class="progress-bar bg-info" id="mem_msg_bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="col-6 ps-4">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="stat-label">RRset Cache</span>
                                <span class="txt-small text-bright" id="mem_rr_txt">-- / --</span>
                            </div>
                            <div class="progress progress-micro">
                                <div class="progress-bar" style="background-color: var(--acc-blue);" id="mem_rr_bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3 pt-2 border-top border-secondary">
                        <div class="col-6 border-end border-secondary d-flex justify-content-between align-items-center">
                            <span class="stat-label">Cached Messages</span>
                            <span class="stat-value" id="ucc_msg">--</span>
                        </div>
                        <div class="col-6 d-flex justify-content-between align-items-center ps-4">
                            <span class="stat-label">Cached RRsets</span>
                            <span class="stat-value" id="ucc_rr">--</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card chart-card-padding">
                <h6 class="card-title text-center text-muted mb-2" style="text-transform:uppercase; font-size: 0.8rem; letter-spacing: 1px;">Latency Distribution</h6>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-muted">
        <hr>
        <p class="mb-0">
            <a href="https://github.com/panoc/pihole-latency-stats" target="_blank">pihole-latency-stats</a>
            is maintained by
            <a href="https://github.com/panoc" target="_blank">panoc</a>.
        </p>
    </footer>

</div>

<script>
    function calcPct(part, total) {
        if (!total || total == 0) return "(0.0%)";
        return "(" + ((part / total) * 100).toFixed(1) + "%)";
    }

    function generateVibrantColors(count) {
        const colors = []; const borders = [];
        for (let i = 0; i < count; i++) {
            const h = (Math.floor((360 / count) * i) + 200) % 360; 
            colors.push(`hsla(${h}, 75%, 60%, 0.7)`);
            borders.push(`hsla(${h}, 75%, 60%, 1)`);
        }
        return { bg: colors, border: borders };
    }

    Chart.register({
        id: 'customDataLabels',
        afterDatasetsDraw: (chart) => {
            const { ctx } = chart;
            ctx.save();
            ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
            ctx.font = 'bold 11px sans-serif'; ctx.fillStyle = '#e6dfdf';
            chart.data.datasets.forEach((dataset, i) => {
                chart.getDatasetMeta(i).data.forEach((bar, index) => {
                    const value = dataset.data[index];
                    if (value > 0) ctx.fillText(value, bar.x, bar.y - 3);
                });
            });
            ctx.restore();
        }
    });

    let refreshSeconds = 60;
    const urlParams = new URLSearchParams(window.location.search);
const profile = urlParams.get('p') || 'default'; // Now defaults to 'default'
let jsonFilename = 'dash_' + profile + '.json';


if (profile !== 'default') {
    const safeProfile = profile.replace(/[^a-z0-9]/gi, '');
    document.title = "Stats: " + safeProfile.toUpperCase();
    document.getElementById('profile-container').style.display = 'block';
    document.getElementById('profile-indicator').innerText = "Profile loaded : " + safeProfile;
} else {
    document.getElementById('profile-container').style.display = 'none';
}

    async function fetchData() {
        try {
            const response = await fetch(jsonFilename + '?t=' + new Date().getTime());
            if (!response.ok) throw new Error("File " + jsonFilename + " not found");
            const data = await response.json();

            refreshSeconds = 60;
            updateTimerDisplay();

            document.getElementById('header_date').innerText = "Last Analysis: " + data.date;
            document.getElementById('time_period').innerText = data.time_period || "All Time";
            document.getElementById('query_mode').innerText = data.mode || "Normal";

            const s = data.stats;
            document.getElementById('p_total').innerText = s.total_queries;
            document.getElementById('p_invalid').innerText = s.unsuccessful;
            document.getElementById('p_invalid_pct').innerText = calcPct(s.unsuccessful, s.total_queries);
            document.getElementById('p_valid').innerText = s.total_valid;
            document.getElementById('p_blocked').innerText = s.blocked;
            document.getElementById('p_blocked_pct').innerText = calcPct(s.blocked, s.total_valid);
            document.getElementById('p_analyzed').innerText = s.analyzed;
            document.getElementById('p_analyzed_pct').innerText = calcPct(s.analyzed, s.total_valid);
            
            const l = data.latency;
            document.getElementById('p_avg').innerText = l.average + " ms";
            document.getElementById('p_med').innerText = l.median + " ms";
            document.getElementById('p_95').innerText  = l.p95 + " ms";

            const u = data.unbound;
            if (u) {
                const statusEl = document.getElementById('u_status_badge');
                if (u.status && u.status.toLowerCase() === 'active') {
                    statusEl.innerText = "Active";
                    statusEl.className = "badge bg-success";
                } else {
                    statusEl.innerText = "Not Active";
                    statusEl.className = "badge bg-danger";
                }

                document.getElementById('u_total').innerText  = u.total;
                document.getElementById('u_hits').innerText = u.hits;
                document.getElementById('u_hit_pct').innerText = "(" + u.ratio + "%)";
                document.getElementById('u_miss').innerText = u.miss;
                document.getElementById('u_miss_pct').innerText = "(" + (100 - parseFloat(u.ratio)).toFixed(2) + "%)";
                document.getElementById('u_pre').innerText = u.prefetch;
                document.getElementById('u_pre_pct').innerText = calcPct(u.prefetch, u.hits) + " of Hits";
                
                const mM = u.memory.msg;
                document.getElementById('mem_msg_txt').innerText = mM.used_mb + "MB / " + mM.limit_mb + "MB (" + mM.percent + "%)";
                document.getElementById('mem_msg_bar').style.width = mM.percent + "%";
                const mR = u.memory.rrset;
                document.getElementById('mem_rr_txt').innerText = mR.used_mb + "MB / " + mR.limit_mb + "MB (" + mR.percent + "%)";
                document.getElementById('mem_rr_bar').style.width = mR.percent + "%";
                
                if (u.cache_count) {
                    document.getElementById('ucc_msg').innerText = u.cache_count.messages;
                    document.getElementById('ucc_rr').innerText  = u.cache_count.rrsets;
                }
            }
            renderChart(data.tiers);
        } catch (error) {
            console.error(error);
            document.getElementById('header_date').innerText = "Status: " + error.message;
        }
    }

    let myChart = null;
    function renderChart(tiers) {
        const ctx = document.getElementById('latencyChart').getContext('2d');
        const labels = tiers.map(t => t.label.replace("Tier ", "T"));
        const dataPoints = tiers.map(t => t.count);
        const palette = generateVibrantColors(dataPoints.length);

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Queries',
                    data: dataPoints,
                    backgroundColor: palette.bg,
                    borderColor: palette.border,
                    borderWidth: 1,
                    borderRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 20 } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#343a40' }, ticks: { color: '#e6dfdf', font: {size: 10} } },
                    x: { grid: { display: false }, ticks: { color: '#e6dfdf', font: {size: 10} } }
                },
                plugins: { legend: { display: false }, tooltip: { enabled: true } }
            }
        });
    }

    function updateTimerDisplay() {
        document.getElementById('refreshTimer').innerText = "Auto-refresh in " + refreshSeconds + "s";
    }

    setInterval(() => {
        refreshSeconds--;
        if (refreshSeconds <= 0) {
            fetchData();
        } else {
            updateTimerDisplay();
        }
    }, 1000);

    fetchData();
</script>

</body>
</html>