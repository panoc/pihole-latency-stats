<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi-hole Latency Stats Dashboard</title>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png?v=3">
    <link href="bootstrap.min.css" rel="stylesheet">
    <script src="chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            /* --- COLOR PALETTE (Dark Default) --- */
            --page-bg:   linear-gradient(120deg, #420808, #1a1a1a);
            --text-main:    #e0e0e0;
            --text-bright:  #e6dfdf;
            --text-muted:   #b0b0b0;
            --bg-card:      #1f2226;
            --border-color: #343a40;
            --chart-grid:   #343a40;
            --chart-text:   #b0b0b0;
            --scroll-track: #2c3036;
            --scroll-thumb: #f39c12;
            --btn-bg:       #343a40;
            
            /* --- ACCENT COLORS --- */
            --acc-green:    #00a65a; --acc-blue:     #3c8dbc;
            --acc-bluepal:  #614DE6; --acc-vibrant:  #4aa3df;
            --acc-yellow:   #f39c12; --acc-red:      #dd4b39;
            --acc-purple:   #9b59b6; --acc-pink:     #e91e63;
            --acc-teal:     #20c997; --acc-indigo:   #6610f2;
            --acc-cyan:     #17a2b8; --acc-orange:   #fd7e14;
            --acc-orangepal:#E6614D; --acc-lime:     #d4e157;
            --acc-slate:    #BA4E73; --acc-blurple:  #6c5ce7; 
            --acc-orchid:   #e056fd;

            /* --- DIMENSIONS --- */
            --page-width:       1200px;
            --chart-h-std:      300px; 
            --chart-h-exp:      500px; 
            --chart-h-dist:     435px; 
            --chart-h-dist-exp: 720px; 
        }

        /* --- THEMES --- */
        [data-theme="light"] {
            --page-bg:      linear-gradient(120deg, #f5f7fa 0%, #c3cfe2 100%);
            --text-main:    #333333; --text-bright:  #111111;
            --text-muted:   #555555; --bg-card:      rgba(248, 250, 252, 0.85); 
            --border-color: #bdc3c7; --chart-grid:   #d0d6db;
            --chart-text:   #444444; --scroll-track: #d0d6db;
            --scroll-thumb: #5a7d9a; --btn-bg:       #ffffff;
            /* Recalibrated Accents */
            --acc-green: #1e7e34; --acc-blue: #2c5985; --acc-vibrant: #2c5985;
            --acc-yellow: #d35400; --acc-red: #c0392b; --acc-purple: #8e44ad;
            --acc-pink: #c2185b; --acc-teal: #157347; --acc-indigo: #520dc2;
            --acc-cyan: #0c8599; --acc-orange: #cf620b; --acc-lime: #827717;
            --acc-slate: #CC557F; --acc-blurple: #4834d4; --acc-orchid: #be2edd;
        }

        [data-theme="contrast"] {
            --page-bg:      #000000; --text-main:    #ffffff;
            --text-bright:  #ffffff; --text-muted:   #dddddd;
            --bg-card:      #000000; --border-color: #ffffff;
            --chart-grid:   #333333; --chart-text:   #ffffff;
            --scroll-track: #333333; --scroll-thumb: #ffff00;
            --btn-bg:       #000000;
            /* High Vis Accents */
            --acc-green: #00ff00; --acc-blue: #00ffff; --acc-vibrant: #00ffff;
            --acc-yellow: #ffff00; --acc-red: #ff0000; --acc-purple: #ff00ff;
            --acc-pink: #ff00ff; --acc-teal: #00ffcc; --acc-indigo: #bb99ff;
            --acc-cyan: #00ffff; --acc-orange: #ff9900; --acc-lime: #ccff00;
            --acc-slate: #ffffff; --acc-blurple: #5f27cd; --acc-orchid: #ff00cc; 
        }

        /* --- LAYOUT --- */
        body {
            background: var(--page-bg); background-attachment: fixed; background-size: cover;
            min-height: 100vh; color: var(--text-main);
            padding: 15px 0 30px 0;
            font-family: 'Source Sans Pro', 'Segoe UI', Helvetica, Arial, sans-serif;
            font-size: 0.9rem; transition: color 0.3s, background 0.3s;
        }
        .container { max-width: var(--page-width) !important; }

        /* --- CARDS & HELPERS --- */
        .card {
            background-color: var(--bg-card); box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: none; border-top: 3px solid var(--border-color);
            margin-bottom: 1px; border-radius: 4px;
            transition: background-color 0.3s ease, border-color 0.3s;
            overflow: hidden;
        }
        [data-theme="contrast"] .card { border: 1px solid #fff; border-top-width: 3px; }

        /* Top Border Accents */
        .border-acc-blue { border-top-color: var(--acc-blue) !important; }
        .border-acc-green { border-top-color: var(--acc-green) !important; }
        .border-acc-yellow { border-top-color: var(--acc-yellow) !important; }
        .border-acc-purple { border-top-color: var(--acc-purple) !important; }
        .border-acc-red { border-top-color: var(--acc-red) !important; }
        .border-acc-vibrant { border-top-color: var(--acc-vibrant) !important; }
        .border-acc-pink { border-top-color: var(--acc-pink) !important; }

        .card-header {
            background-color: rgba(128,128,128,0.05); border-bottom: 1px solid var(--border-color);
            font-weight: 600; color: var(--text-bright); font-size: 1rem;
            padding: 4px 15px; display: flex; justify-content: space-between;
            align-items: center; min-height: 35px; position: relative;
        }

        .header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
            color: var(--text-muted); font-weight: 600; white-space: nowrap; pointer-events: none;
        }

        /* --- CHARTS --- */
        .card-content-wrapper { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; overflow: hidden; display: block; }
        .card-content-wrapper.collapsed { display: none; }

        .chart-scroll-window {
            width: 100%; overflow-x: auto; overflow-y: hidden; padding-bottom: 15px;
            scrollbar-width: auto; scrollbar-color: var(--scroll-thumb) var(--scroll-track);
        }
        .chart-scroll-window::-webkit-scrollbar { height: 16px; display: block; background: var(--scroll-track); }
        .chart-scroll-window::-webkit-scrollbar-track { background-color: var(--scroll-track); border-top: 1px solid var(--border-color); }
        .chart-scroll-window::-webkit-scrollbar-thumb { background-color: var(--scroll-thumb); border-radius: 8px; border: 4px solid var(--scroll-track); min-width: 50px; }
        .chart-scroll-window::-webkit-scrollbar-thumb:hover { filter: brightness(1.2); }

        .chart-container, .chart-container-scrollable { 
            height: var(--chart-h-std); position: relative; width: 100%; 
            transition: height 0.3s ease, width 0.3s ease; 
        }
        .chart-expanded { height: var(--chart-h-exp) !important; }
        #dist-chart-container:not(.chart-expanded) { height: var(--chart-h-dist); }
        #dist-chart-container.chart-expanded { height: var(--chart-h-dist-exp) !important; }
        .chart-card-padding { padding: 15px !important; margin-bottom: 15px !important; }

        /* --- LEGEND --- */
        .external-legend-container {
            display: flex; justify-content: center; flex-wrap: wrap; padding: 2px 0; gap: 15px;
            position: sticky; top: 0; z-index: 5; padding: 0 20px;
        }
        .legend-item { display: flex; align-items: center; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); user-select: none; transition: opacity 0.2s; }
        .legend-item:hover { color: var(--text-bright); }
        .legend-box { width: 14px; height: 14px; margin-right: 6px; border-radius: 3px; border: 2px solid transparent; }
        .legend-item.hidden .legend-box { background-color: transparent !important; }
        .legend-item.hidden span { opacity: 0.6; }

        /* --- METRICS --- */
        .card-body-inner { padding: 5px 15px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid rgba(128,128,128,0.1); min-height: 24px; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-main); font-weight: 400; flex-grow: 1; font-size: 0.95rem; }
        .stat-data-container { display: flex; align-items: center; justify-content: flex-end; width: 200px; }
        .stat-value { font-weight: 700; color: var(--text-bright); font-variant-numeric: tabular-nums; font-size: 1rem; text-align: right; }
        .mem-value { min-width: 140px; }
        .badge-sub { font-size: 0.8em; color: var(--text-muted); width: 85px; text-align: right; margin-left: 5px; font-weight: normal; }
        
        /* --- UTILS --- */
        .progress { background-color: rgba(128,128,128,0.15); margin: 4px 0; }
        .progress-micro { height: 5px; border-radius: 4px; }
        
        .bg-secondary { background-color: #343a40 !important; color: #fff; }
        [data-theme="light"] .bg-secondary { background-color: #6c757d !important; }
        .bg-primary { background-color: var(--acc-blue) !important; }
        .bg-success { background-color: var(--acc-green) !important; }
        .bg-danger { background-color: var(--acc-red) !important; }
        [data-theme="contrast"] .btn-filter.active, [data-theme="contrast"] .badge { color: #000000 !important; font-weight: 800; }

        h3 { color: var(--text-bright); font-weight: 300; margin-bottom: 0; font-size: 1.6rem; }
        hr { border-top-color: var(--border-color); opacity: 0.5; margin: 0.6rem 0; }
        #refreshTimer { font-family: monospace; opacity: 0.7; font-size: 0.85em; margin-right: 10px; color: var(--text-main); }
        .header-logo-svg { height: 36px; width: auto; margin-right: 12px; vertical-align: middle; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3)); }
        .header-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-top: 0; }
        .card-profile-footer { text-align: center; padding: 12px 0; background: rgba(128,128,128,0.05); border-top: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; }
        .footer-val { color: var(--acc-blue); font-weight: 700; margin: 0 5px; }

        /* --- FOOTER & TIPS --- */
        .dashboard-tip { background-color: rgba(60, 141, 188, 0.1); color: var(--text-muted); padding: 8px 12px; margin-top: 20px; margin-bottom: 15px; border-radius: 4px; font-size: 0.85rem; text-align: center; border: 1px solid transparent; }
        [data-theme="light"] .dashboard-tip { background-color: #e3f2fd; color: #004085; border-color: #b8daff; }
        [data-theme="contrast"] .dashboard-tip { border: 1px solid #fff; color: #fff; }
        .dashboard-tip a { color: var(--text-bright); text-decoration: none; border-bottom: 1px solid rgba(128,128,128,0.3); }
        .dashboard-tip a:hover { color: var(--acc-vibrant); border-bottom-color: var(--acc-vibrant); }
        
        .version-footer { 
            display: flex; justify-content: center; align-items: center; 
            padding-top: 15px; border-top: 1px solid var(--border-color); 
            font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; gap: 10px;
        }
        .v-num { color: var(--acc-vibrant); font-weight: 700; font-family: monospace; }
        .new-version-link { color: var(--acc-yellow); text-decoration: none; font-weight: bold; margin-left: 5px; }

        /* --- CONTROLS --- */
        .header-controls { display: flex; align-items: center; gap: 6px; z-index: 2; }
        .btn-filter, .btn-icon, .form-select-sm { 
            background: var(--btn-bg); border: 1px solid var(--border-color); color: var(--text-muted); 
            padding: 2px 10px; font-size: 0.75rem; border-radius: 3px; transition: all 0.2s; cursor: pointer; text-align: center; 
        }
        .btn-icon { padding: 0px 8px; font-size: 0.9rem; font-weight: bold; min-width: 25px; }
        .btn-filter:hover, .btn-icon:hover, .btn-filter.active, .btn-icon.active { 
            background: var(--acc-blue); border-color: var(--acc-blue); color: var(--text-bright); 
        }
        .btn-filter.active, .btn-icon.active { color: #fff; }
        .btn-min { margin-left: 8px; }
        
        #themeSelector { height: 24px; padding: 0 5px; font-size: 0.75rem; background: var(--btn-bg); color: var(--text-main); border: 1px solid var(--border-color); margin-left: 10px; }
        .custom-range-inputs { display: none; align-items: center; gap: 5px; margin-left: 5px; margin-bottom: 8px; padding-left: 5px; }
        .custom-range-inputs.show { display: flex; }
        .date-input { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); padding: 1px 5px; border-radius: 3px; font-size: 0.75rem; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.6; cursor: pointer; transform: scale(0.8); }
        [data-theme="light"] ::-webkit-calendar-picker-indicator { filter: none; }
        
        /* Stats Grid */
        .stat-grid-row { margin-left: -15px; margin-right: -15px; background: rgba(128,128,128,0.05); border-color: var(--border-color) !important; }
        .stat-grid-col { border-color: var(--border-color) !important; }
        .stat-grid-label { color: var(--text-muted); font-size:0.75rem; letter-spacing: 1px; font-weight: 600; }

        /* =========================================
           1. LOG BUTTONS („èí) - INDEPENDENT
           ========================================= */
        button[id*="-log-btn"] {
            height: 24px !important; max-height: 24px !important; display: inline-flex !important;
            align-items: center; justify-content: center; padding: 0px 8px !important; padding-bottom: 5px !important; 
        }

        /* =========================================
           2. SCROLL BUTTONS (‚Üî) - INDEPENDENT
           ========================================= */
        button[id*="-scroll-btn"] {
            height: 24px !important; max-height: 24px !important; display: inline-flex !important;
            align-items: center; justify-content: center; padding: 0px 8px !important; padding-bottom: 3px !important; 
        } 
        /* =========================================
           3. CHART TYPE BUTTON (üìà/üìä)
           ========================================= */
        button[id*="-type-btn"] {
            height: 24px !important; max-height: 24px !important; display: inline-flex !important;
            align-items: center; justify-content: center; padding: 0px 8px !important; padding-bottom: 2px !important; 
        }

        /* =========================================
           4. EXPAND BUTTON (‚Üï)
           ========================================= */
        button[id*="-expand-btn"] {
            height: 24px !important; max-height: 24px !important; display: inline-flex !important;
            align-items: center; justify-content: center; padding: 0px 8px !important; padding-bottom: 5px !important; 
        }

        /* =========================================
           5. MINIMIZE/COLLAPSE BUTTON (‚àí/+)
           ========================================= */
        button[id*="-collapse-btn"] {
            height: 24px !important; max-height: 24px !important; display: inline-flex !important;
            align-items: center; justify-content: center; padding: 0px 8px !important; padding-bottom: 4px !important; 
        }
        
        /* =========================================
           6. MOVE/RESET BUTTONS (‚Üë ‚Üì ‚ü≤)
           ========================================= */
        .btn-move, .btn-reset {
            height: 24px !important; max-height: 24px !important; display: inline-flex !important;
            align-items: center; justify-content: center; padding: 0px 5px !important; 
            padding-bottom: 3px !important; font-size: 0.8rem;
        }
        .btn-reset { font-size: 0.9rem; font-weight: bold; }
   </style>
</head>
<body>

<div class="container">
    <div class="header-wrapper">
        <div class="d-flex align-items-center">
            <svg class="header-logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <rect x="10" y="50" width="18" height="50" rx="2" fill="#3c8dbc"/>
                <rect x="32" y="30" width="18" height="70" rx="2" fill="#00a65a"/>
                <rect x="54" y="45" width="18" height="55" rx="2" fill="#f39c12"/>
                <rect x="76" y="70" width="18" height="30" rx="2" fill="#dd4b39"/>
                <path d="M41 30 Q30 10 20 25 Q30 35 41 30 Z" fill="#00a65a"/>
                <path d="M41 30 Q52 10 62 25 Q52 35 41 30 Z" fill="#00a65a"/>
            </svg>
            <h3 id="main-title">Pi-hole Latency Stats</h3>
        </div>
        <div class="d-flex align-items-center flex-column align-items-start">
            <small class="text-muted" id="header_date">Loading...</small>
        </div>
        <div class="d-flex align-items-center">
            <span id="refreshTimer">Auto-refresh in 60s</span>
            <span class="badge bg-secondary ms-2" id="time_period" style="margin-left: 8px;">--</span>
            <span class="badge bg-primary ms-1" id="query_mode" style="margin-left: 4px;">--</span>
            <select id="themeSelector" onchange="applyTheme(this.value)">
                <option value="dark">Dark Theme</option>
                <option value="light">Light Theme</option>
                <option value="contrast">High Contrast</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card h-100 border-acc-blue">
                <div class="card-header">Pi-hole Performance</div>
                <div class="card-body card-body-inner">
                    <div class="stat-row"><span class="stat-label">Total Queries</span><div class="stat-data-container"><span class="stat-value" id="p_total">--</span><span class="badge-sub"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Unsuccessful</span><div class="stat-data-container"><span class="stat-value" id="p_invalid">--</span><span class="badge-sub" id="p_invalid_pct"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Total Valid</span><div class="stat-data-container"><span class="stat-value" id="p_valid">--</span><span class="badge-sub"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Blocked / Ignored</span><div class="stat-data-container"><span class="stat-value" id="p_blocked">--</span><span class="badge-sub" id="p_blocked_pct"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Analyzed</span><div class="stat-data-container"><span class="stat-value" id="p_analyzed">--</span><span class="badge-sub" id="p_analyzed_pct"></span></div></div>
                    
                    <div class="row text-center mt-3 pt-2 border-top border-secondary stat-grid-row">
                        <div class="col-3 border-end border-secondary py-2 stat-grid-col">
                            <div class="small mb-1 stat-grid-label">AVERAGE</div>
                            <div class="h4 mb-0" style="color: var(--acc-vibrant); font-weight: 700;" id="p_avg">--</div>
                        </div>
                        <div class="col-3 border-end border-secondary py-2 stat-grid-col">
                            <div class="small mb-1 stat-grid-label">STD DEV</div>
                            <div class="h4 mb-0" style="color: var(--acc-red); font-weight: 700;" id="p_std">--</div>
                        </div>
                        <div class="col-3 border-end border-secondary py-2 stat-grid-col">
                            <div class="small mb-1 stat-grid-label">MEDIAN</div>
                            <div class="h4 mb-0" style="color: var(--acc-green); font-weight: 700;" id="p_med">--</div>
                        </div>
                        <div class="col-3 py-2">
                            <div class="small mb-1 stat-grid-label">95th %</div>
                            <div class="h4 mb-0" style="color: var(--acc-yellow); font-weight: 700;" id="p_95">--</div>
                        </div>
                    </div>
                </div>
                <div class="card-profile-footer">Profile : <span class="footer-val" id="profile-indicator">DEFAULT</span></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 border-acc-green">
                <div class="card-header"><span>Unbound Performance</span><span id="u_status_badge" class="badge bg-secondary">Checking...</span></div>
                <div class="card-body card-body-inner">
                    <div class="stat-row"><span class="stat-label">Total Queries</span><div class="stat-data-container"><span class="stat-value" id="u_total">--</span><span class="badge-sub"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Hits</span><div class="stat-data-container"><span class="stat-value" id="u_hits">--</span><span class="badge-sub" id="u_hit_pct"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Misses</span><div class="stat-data-container"><span class="stat-value" id="u_miss">--</span><span class="badge-sub" id="u_miss_pct"></span></div></div>
                    <div class="stat-row"><span class="stat-label">Prefetch Jobs</span><div class="stat-data-container"><span class="stat-value" id="u_pre">--</span><span class="badge-sub" id="u_pre_pct"></span></div></div>
                    <hr>
                    <div class="row">
                        <div class="col-12"><div class="d-flex justify-content-between align-items-center mb-1"><span class="stat-label">Msg Cache</span><span class="stat-value mem-value" id="mem_msg_txt">-- / --</span></div><div class="progress progress-micro mb-2"><div class="progress-bar" id="mem_msg_bar" style="width: 0%; background-color: var(--acc-cyan);"></div></div></div>
                        <div class="col-12"><div class="d-flex justify-content-between align-items-center mb-1"><span class="stat-label">RRset Cache</span><span class="stat-value mem-value" id="mem_rr_txt">-- / --</span></div><div class="progress progress-micro"><div class="progress-bar" id="mem_rr_bar" style="width: 0%; background-color: var(--acc-lime);"></div></div></div>
                    </div>
                </div>
                <div class="card-profile-footer">Messages : <span class="footer-val" id="ucc_msg">--</span><span class="mx-2 opacity-25">|</span>RRsets : <span class="footer-val" id="ucc_rr">--</span></div>
            </div>
        </div>
    </div>

    <div id="chart-sort-container">

        <div class="row mt-3" id="row-dist">
            <div class="col-12">
                <div class="card chart-card-padding border-acc-yellow">
                    <div class="card-header border-0 bg-transparent p-0 mb-1 d-flex justify-content-between align-items-center">
                        <div class="header-controls">
                            <button class="btn-filter f-dist f-12h active" onclick="updateDistTime('12h')">12H</button>
                            <button class="btn-filter f-dist f-24h" onclick="updateDistTime('24h')">24H</button>
                            <button class="btn-filter f-dist f-7d" onclick="updateDistTime('7d')">7D</button>
                            <button class="btn-filter f-dist f-30d" onclick="updateDistTime('30d')">30D</button>
                            <button class="btn-filter f-dist f-all" onclick="updateDistTime('all')">All Time</button>
                            <button class="btn-icon active" id="dist-log-btn" title="Toggle Log Scale" onclick="toggleLog('dist')">„èí</button>
                        </div>
                        <div class="header-title">LATENCY DISTRIBUTION</div>
                        <div class="header-controls">
                            <button class="btn-icon btn-reset" onclick="resetOrder()" title="Reset Order">‚ü≤</button>
                            <button class="btn-icon btn-min" id="dist-expand-btn" onclick="toggleHeight('dist-chart-container', this)">&#8597;</button>
                            <button class="btn-icon btn-move" onclick="moveUp('row-dist')">‚Üë</button>
                            <button class="btn-icon btn-move" onclick="moveDown('row-dist')">‚Üì</button>
                            <button class="btn-icon btn-min" id="dist-collapse-btn" onclick="toggleCollapse('dist-chart-content', this)">&#8722;</button>
                        </div>
                    </div>
                    <div id="dist-chart-content" class="card-content-wrapper">
                        <div class="chart-container" id="dist-chart-container"><canvas id="latencyChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3" id="row-lat">
            <div class="col-12">
                <div class="card chart-card-padding border-acc-purple">
                    <div class="card-header border-0 bg-transparent p-0 mb-3 d-flex justify-content-between align-items-center">
                        <div class="header-controls">
                            <button class="btn-filter f-lat f-12h active" onclick="updateLatencyTime('12h')">12H</button>
                            <button class="btn-filter f-lat f-24h" onclick="updateLatencyTime('24h')">24H</button>
                            <button class="btn-filter f-lat f-7d" onclick="updateLatencyTime('7d')">7D</button>
                            <button class="btn-filter f-lat f-30d" onclick="updateLatencyTime('30d')">30D</button>
                            <button class="btn-filter f-lat f-cust" onclick="updateLatencyTime('cust')">Custom</button>
                            <button class="btn-icon" id="lat-log-btn" title="Toggle Log Scale" onclick="toggleLog('lat')">„èí</button>
                            <button class="btn-icon" id="lat-type-btn" title="Toggle Bar/Line" onclick="toggleChartType('lat')">üìà</button>
                            <button class="btn-icon" id="lat-scroll-btn" title="Toggle Scroll" onclick="toggleScroll('lat')">‚Üî</button>
                        </div>
                        <div class="header-title">Latency History (ms)</div> 
                        <div class="header-controls">
                            <div id="latency-legend" class="external-legend-container"></div>
                            <button class="btn-icon btn-reset" onclick="resetOrder()" title="Reset Order">‚ü≤</button>
                            <button class="btn-icon btn-min" id="lat-expand-btn" onclick="toggleHeight('latency-chart-container', this)">&#8597;</button>
                            <button class="btn-icon btn-move" onclick="moveUp('row-lat')">‚Üë</button>
                            <button class="btn-icon btn-move" onclick="moveDown('row-lat')">‚Üì</button>
                            <button class="btn-icon btn-min" id="lat-collapse-btn" onclick="toggleCollapse('lat-chart-content', this)">&#8722;</button>
                        </div>
                    </div>
                    <div class="custom-range-inputs" id="lat-custom-inputs">
                        <input type="datetime-local" class="date-input" id="lat-start"><span class="text-muted">-</span><input type="datetime-local" class="date-input" id="lat-end">
                        <button class="btn-filter" style="border-color: var(--acc-green); color: var(--acc-green)" onclick="applyLatencyCustom()">Go</button>
                    </div>
                    <div id="lat-chart-content" class="card-content-wrapper">
                        <div class="chart-scroll-window" id="latency-scroll-window">
                            <div class="chart-container-scrollable" id="latency-chart-container"><canvas id="historyChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3" id="row-sd">
            <div class="col-12">
                <div class="card chart-card-padding border-acc-red">
                    <div class="card-header border-0 bg-transparent p-0 mb-3 d-flex justify-content-between align-items-center">
                        <div class="header-controls">
                            <button class="btn-filter f-sd f-12h active" onclick="updateSdTime('12h')">12H</button>
                            <button class="btn-filter f-sd f-24h" onclick="updateSdTime('24h')">24H</button>
                            <button class="btn-filter f-sd f-7d" onclick="updateSdTime('7d')">7D</button>
                            <button class="btn-filter f-sd f-30d" onclick="updateSdTime('30d')">30D</button>
                            <button class="btn-filter f-sd f-cust" onclick="updateSdTime('cust')">Custom</button>
                            <button class="btn-icon" id="sd-log-btn" title="Toggle Log Scale" onclick="toggleLog('sd')">„èí</button>
                            <button class="btn-icon" id="sd-type-btn" title="Toggle Bar/Line" onclick="toggleChartType('sd')">üìà</button>
                            <button class="btn-icon" id="sd-scroll-btn" title="Toggle Scroll" onclick="toggleScroll('sd')">‚Üî</button>
                        </div>
                        <div class="header-title">STANDARD DEVIATION (ms)</div>
                        <div class="header-controls">
                            <div id="sd-legend" class="external-legend-container"></div>
                            <button class="btn-icon btn-reset" onclick="resetOrder()" title="Reset Order">‚ü≤</button>
                            <button class="btn-icon btn-min" id="sd-expand-btn" onclick="toggleHeight('sd-chart-container', this)">&#8597;</button>
                            <button class="btn-icon btn-move" onclick="moveUp('row-sd')">‚Üë</button>
                            <button class="btn-icon btn-move" onclick="moveDown('row-sd')">‚Üì</button>
                            <button class="btn-icon btn-min" id="sd-collapse-btn" onclick="toggleCollapse('sd-chart-content', this)">&#8722;</button>
                        </div>
                    </div>
                    <div class="custom-range-inputs" id="sd-custom-inputs">
                        <input type="datetime-local" class="date-input" id="sd-start"><span class="text-muted">-</span><input type="datetime-local" class="date-input" id="sd-end">
                        <button class="btn-filter" style="border-color: var(--acc-green); color: var(--acc-green)" onclick="applySdCustom()">Go</button>
                    </div>
                    <div id="sd-chart-content" class="card-content-wrapper">
                        <div class="chart-scroll-window" id="sd-scroll-window">
                            <div class="chart-container-scrollable" id="sd-chart-container"><canvas id="sdChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3" id="row-eff">
            <div class="col-12">
                <div class="card chart-card-padding border-acc-vibrant">
                    <div class="card-header border-0 bg-transparent p-0 mb-3 d-flex justify-content-between align-items-center">
                        <div class="header-controls">
                            <button class="btn-filter f-eff f-12h active" onclick="updateEffTime('12h')">12H</button>
                            <button class="btn-filter f-eff f-24h" onclick="updateEffTime('24h')">24H</button>
                            <button class="btn-filter f-eff f-7d" onclick="updateEffTime('7d')">7D</button>
                            <button class="btn-filter f-eff f-30d" onclick="updateEffTime('30d')">30D</button>
                            <button class="btn-filter f-eff f-cust" onclick="updateEffTime('cust')">Custom</button>
                            <button class="btn-icon" id="eff-log-btn" title="Toggle Log Scale" onclick="toggleLog('eff')">„èí</button>
                            <button class="btn-icon" id="eff-type-btn" title="Toggle Bar/Line" onclick="toggleChartType('eff')">üìà</button>
                            <button class="btn-icon" id="eff-scroll-btn" title="Toggle Scroll" onclick="toggleScroll('eff')">‚Üî</button>
                        </div>
                        <div class="header-title">UNBOUND CACHE HIT rate</div>
                        <div class="header-controls">
                            <div id="efficiency-legend" class="external-legend-container"></div>            
                            <button class="btn-icon btn-reset" onclick="resetOrder()" title="Reset Order">‚ü≤</button>
                            <button class="btn-icon btn-min" id="eff-expand-btn" onclick="toggleHeight('efficiency-chart-container', this)">&#8597;</button>
                            <button class="btn-icon btn-move" onclick="moveUp('row-eff')">‚Üë</button>
                            <button class="btn-icon btn-move" onclick="moveDown('row-eff')">‚Üì</button>
                            <button class="btn-icon btn-min" id="eff-collapse-btn" onclick="toggleCollapse('eff-chart-content', this)">&#8722;</button>
                        </div>
                    </div>
                    <div class="custom-range-inputs" id="eff-custom-inputs">
                        <input type="datetime-local" class="date-input" id="eff-start"><span class="text-muted">-</span><input type="datetime-local" class="date-input" id="eff-end">
                        <button class="btn-filter" style="border-color: var(--acc-green); color: var(--acc-green)" onclick="applyEffCustom()">Go</button>
                    </div>
                    <div id="eff-chart-content" class="card-content-wrapper">
                        <div class="chart-scroll-window" id="efficiency-scroll-window">
                            <div class="chart-container-scrollable" id="efficiency-chart-container"><canvas id="efficiencyChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3" id="row-unb">
            <div class="col-12">
                <div class="card chart-card-padding border-acc-pink">
                    <div class="card-header border-0 bg-transparent p-0 mb-3 d-flex justify-content-between align-items-center">
                        <div class="header-controls">
                            <button class="btn-filter f-unb f-12h active" onclick="updateUnboundTime('12h')">12H</button>
                            <button class="btn-filter f-unb f-24h" onclick="updateUnboundTime('24h')">24H</button>
                            <button class="btn-filter f-unb f-7d" onclick="updateUnboundTime('7d')">7D</button>
                            <button class="btn-filter f-unb f-30d" onclick="updateUnboundTime('30d')">30D</button>
                            <button class="btn-filter f-unb f-cust" onclick="updateUnboundTime('cust')">Custom</button>
                            <button class="btn-icon" id="unb-log-btn" title="Toggle Log Scale" onclick="toggleLog('unb')">„èí</button>
                            <button class="btn-icon" id="unb-type-btn" title="Toggle Bar/Line" onclick="toggleChartType('unb')">üìà</button>
                            <button class="btn-icon" id="unb-scroll-btn" title="Toggle Scroll" onclick="toggleScroll('unb')">‚Üî</button>
                        </div>
                        <div class="header-title">Unbound cached items </div>
                        <div class="header-controls">
                            <div id="unbound-legend" class="external-legend-container"></div>
                            <button class="btn-icon btn-reset" onclick="resetOrder()" title="Reset Order">‚ü≤</button>
                            <button class="btn-icon btn-min" id="unb-expand-btn" onclick="toggleHeight('unbound-chart-container', this)">&#8597;</button>
                            <button class="btn-icon btn-move" onclick="moveUp('row-unb')">‚Üë</button>
                            <button class="btn-icon btn-move" onclick="moveDown('row-unb')">‚Üì</button>
                            <button class="btn-icon btn-min" id="unb-collapse-btn" onclick="toggleCollapse('unb-chart-content', this)">&#8722;</button>
                        </div>
                    </div>
                    <div class="custom-range-inputs" id="unb-custom-inputs">
                        <input type="datetime-local" class="date-input" id="unb-start"><span class="text-muted">-</span><input type="datetime-local" class="date-input" id="unb-end">
                        <button class="btn-filter" style="border-color: var(--acc-green); color: var(--acc-green)" onclick="applyUnboundCustom()">Go</button>
                    </div>
                    <div id="unb-chart-content" class="card-content-wrapper">
                        <div class="chart-scroll-window" id="unbound-scroll-window">
                            <div class="chart-container-scrollable" id="unbound-chart-container"><canvas id="unboundChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3" id="row-mem">
            <div class="col-12">
                <div class="card chart-card-padding border-acc-green">
                    <div class="card-header border-0 bg-transparent p-0 mb-3 d-flex justify-content-between align-items-center">
                        <div class="header-controls">
                            <button class="btn-filter f-mem f-12h active" onclick="updateMemTime('12h')">12H</button>
                            <button class="btn-filter f-mem f-24h" onclick="updateMemTime('24h')">24H</button>
                            <button class="btn-filter f-mem f-7d" onclick="updateMemTime('7d')">7D</button>
                            <button class="btn-filter f-mem f-30d" onclick="updateMemTime('30d')">30D</button>
                            <button class="btn-filter f-mem f-cust" onclick="updateMemTime('cust')">Custom</button>
                            <button class="btn-icon" id="mem-log-btn" title="Toggle Log Scale" onclick="toggleLog('mem')">„èí</button>
                            <button class="btn-icon" id="mem-type-btn" title="Toggle Bar/Line" onclick="toggleChartType('mem')">üìà</button>
                            <button class="btn-icon" id="mem-scroll-btn" title="Toggle Scroll" onclick="toggleScroll('mem')">‚Üî</button>
                        </div>
                        <div class="header-title">Unbound Cache Memory</div>
                        <div class="header-controls">
                            <div id="memory-legend" class="external-legend-container"></div>
                            <button class="btn-icon btn-reset" onclick="resetOrder()" title="Reset Order">‚ü≤</button>
                            <button class="btn-icon btn-min" id="mem-expand-btn" onclick="toggleHeight('memory-chart-container', this)">&#8597;</button>
                            <button class="btn-icon btn-move" onclick="moveUp('row-mem')">‚Üë</button>
                            <button class="btn-icon btn-move" onclick="moveDown('row-mem')">‚Üì</button>
                            <button class="btn-icon btn-min" id="mem-collapse-btn" onclick="toggleCollapse('mem-chart-content', this)">&#8722;</button>
                        </div>
                    </div>
                    <div class="custom-range-inputs" id="mem-custom-inputs">
                        <input type="datetime-local" class="date-input" id="mem-start"><span class="text-muted">-</span><input type="datetime-local" class="date-input" id="mem-end">
                        <button class="btn-filter" style="border-color: var(--acc-green); color: var(--acc-green)" onclick="applyMemCustom()">Go</button>
                    </div>
                    <div id="mem-chart-content" class="card-content-wrapper">
                        <div class="chart-scroll-window" id="memory-scroll-window">
                            <div class="chart-container-scrollable" id="memory-chart-container"><canvas id="memoryChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div><div class="dashboard-tip">üí° Use <b>sudo ./pihole_stats.sh -dash</b> via Cron or <b>Use Cron Maker</b> to build the history graph.<br>See <a href="https://github.com/panoc/pihole-latency-stats" target="_blank">Full Documentation</a>.</div>
    
    <div class="version-footer">
        Script version: <span class="v-num" id="script-v-num">Loading...</span> <span id="script-new-v"></span>
        <span style="margin: 0 10px; opacity: 0.5;">|</span>
        Dashboard version: <span class="v-num" id="dash-v-num">--</span> <span id="dash-new-v"></span>
    </div>
</div>

<script>
/**
 * PI-HOLE LATENCY STATS DASHBOARD (Optimized & Gap-Filling & Label Fix & Reorderable & Custom Layout)
 * Features: DRY Code, State Management, Gap Detection, Moveable Graphs, Reset Order.
 */

// --- 1. CONFIGURATION & STATE ---

const currentDashVersion = "v2.1"; 
let fullHistoryData = []; 
let globalData = null; 
let refreshSeconds = 60;
let isFirstLoad = true;
let updateChecked = false;
let fetchFailCount = 0;
const CHART_LINE_THICKNESS = 2.0

// Centralized State Management
const AppState = {
    theme: 'dark',
    charts: {
        lat:  { log: false, type: 'bar', scroll: false, mode: '12h', instance: null, ctxId: 'historyChart', legendId: 'latency-legend' },
        unb:  { log: false, type: 'bar', scroll: false, mode: '12h', instance: null, ctxId: 'unboundChart', legendId: 'unbound-legend' },
        eff:  { log: false, type: 'bar', scroll: false, mode: '12h', instance: null, ctxId: 'efficiencyChart', legendId: 'efficiency-legend' },
        mem:  { log: false, type: 'bar', scroll: false, mode: '12h', instance: null, ctxId: 'memoryChart', legendId: 'memory-legend' },
        sd:   { log: false, type: 'bar', scroll: false, mode: '12h', instance: null, ctxId: 'sdChart', legendId: 'sd-legend' },
        dist: { log: true,  type: 'bar', scroll: false, mode: '12h', instance: null, ctxId: 'latencyChart' } // Dist is special
    },
    // New: Track order of rows
    order: [] 
};

// --- 2. HELPERS & UTILS ---

function getCssVar(name) {
    const val = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return val || "#777777";
}

function getThemePalette() {
    return { 
        avg: getCssVar('--acc-bluepal'), med: getCssVar('--acc-blurple'), p95: getCssVar('--acc-orangepal'),
        msg: getCssVar('--acc-cyan'), rr: getCssVar('--acc-lime'),
        mem_msg: getCssVar('--acc-green'), mem_rr: getCssVar('--acc-purple'),
        diff_hit: getCssVar('--acc-teal'), diff_miss: getCssVar('--acc-red'),
        sd_val: getCssVar('--acc-slate'), sd_avg: getCssVar('--acc-blue')
    };
}

function safeDate(dateStr) {
    if (!dateStr) return new Date();
    return new Date(dateStr.replace(" ", "T"));
}

function formatDateStr(dateObj) {
    const pad = (n) => n < 10 ? '0' + n : n;
    const y = dateObj.getFullYear();
    const m = pad(dateObj.getMonth() + 1);
    const d = pad(dateObj.getDate());
    const h = pad(dateObj.getHours());
    const min = pad(dateObj.getMinutes());
    const s = pad(dateObj.getSeconds());
    return `${y}-${m}-${d} ${h}:${min}:${s}`;
}

function formatK(value) {
    if (value === 0.1 || value === 0) return '0';
    if (value >= 1000000) return (value / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    if (value >= 1000) return (value / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    return value;
}

function calcPct(part, total) {
    if (!total || total == 0) return "(0.0%)";
    return "(" + ((part / total) * 100).toFixed(1) + "%)";
}

function setText(id, txt) {
    const el = document.getElementById(id);
    if(el) el.innerText = txt;
}

// --- 3. STATE PERSISTENCE & REORDERING ---

function moveUp(rowId) {
    const row = document.getElementById(rowId);
    if (row && row.previousElementSibling) {
        row.parentNode.insertBefore(row, row.previousElementSibling);
        saveState();
    }
}

function moveDown(rowId) {
    const row = document.getElementById(rowId);
    if (row && row.nextElementSibling) {
        row.parentNode.insertBefore(row.nextElementSibling, row);
        saveState();
    }
}

function resetOrder() {
    // 1. Load existing state
    const saved = JSON.parse(localStorage.getItem('phls_state_v2')) || {};
    // 2. Clear order key
    delete saved.order;
    // 3. Save
    localStorage.setItem('phls_state_v2', JSON.stringify(saved));
    // 4. Reload page to restore original DOM order
    window.location.reload();
}

function restoreOrder() {
    const container = document.getElementById('chart-sort-container');
    if (!container || !AppState.order || AppState.order.length === 0) return;

    const fragment = document.createDocumentFragment();
    
    AppState.order.forEach(id => {
        const el = document.getElementById(id);
        if (el) fragment.appendChild(el);
    });

    Array.from(container.children).forEach(child => {
        if (!AppState.order.includes(child.id)) fragment.appendChild(child);
    });

    container.appendChild(fragment);
}

function saveState() {
    const saveObj = { theme: AppState.theme, charts: {} };
    for (const [key, cfg] of Object.entries(AppState.charts)) {
        saveObj.charts[key] = { log: cfg.log, type: cfg.type, scroll: cfg.scroll, mode: cfg.mode };
    }
    
    saveObj.ui = {};
    ['lat','unb','eff','mem','sd','dist'].forEach(key => {
        saveObj.ui[key] = {
            exp: document.getElementById(key === 'lat' ? 'latency-chart-container' : key === 'unbound' ? 'unbound-chart-container' : key === 'efficiency' ? 'efficiency-chart-container' : key === 'memory' ? 'memory-chart-container' : key + '-chart-container')?.classList.contains('chart-expanded'),
            col: document.getElementById(key + '-chart-content')?.classList.contains('collapsed')
        };
    });

    const container = document.getElementById('chart-sort-container');
    if(container) {
        saveObj.order = Array.from(container.children).map(child => child.id).filter(id => id);
    }

    localStorage.setItem('phls_state_v2', JSON.stringify(saveObj));
}

function loadState() {
    const saved = JSON.parse(localStorage.getItem('phls_state_v2'));
    if (!saved) return;
    
    if (saved.theme) { 
        document.getElementById('themeSelector').value = saved.theme;
        applyTheme(saved.theme); 
    }
    if (saved.charts) {
        for (const [key, cfg] of Object.entries(saved.charts)) {
            if (AppState.charts[key]) {
                Object.assign(AppState.charts[key], cfg);
                
                // Restore Toggle Buttons
                if (cfg.log) document.getElementById(key + '-log-btn')?.classList.add('active');
                if (cfg.scroll) document.getElementById(key + '-scroll-btn')?.classList.add('active');
                
                // --- FIX: Restore Period Buttons for ALL charts (including Dist) ---
                if (cfg.mode) {
                    updateFilterButtons('f-' + key, cfg.mode);
                    // Handle custom input visibility (safe if element is missing)
                    const ci = document.getElementById(key + '-custom-inputs');
                    if (ci) ci.style.display = (cfg.mode === 'cust') ? 'flex' : 'none';
                }

                const tBtn = document.getElementById(key + '-type-btn');
                if (tBtn) tBtn.innerText = (cfg.type === 'bar') ? 'üìà' : 'üìä'; 
            }
        }
    }
    const mapId = { lat: 'latency', unb: 'unbound', eff: 'efficiency', mem: 'memory', sd: 'sd', dist: 'dist' };
    if (saved.ui) {
        for (const [key, state] of Object.entries(saved.ui)) {
            const domId = mapId[key] || key;
            const containerId = (key === 'sd' || key === 'dist') ? key + '-chart-container' : domId + '-chart-container';
            const contentId = key + '-chart-content';
            const btnExpandId = key + '-expand-btn';
            const btnCollapseId = key + '-collapse-btn';
            if (state.exp) {
                document.getElementById(containerId)?.classList.add('chart-expanded');
                document.getElementById(btnExpandId)?.classList.add('active');
            }
            if (state.col) {
                document.getElementById(contentId)?.classList.add('collapsed');
                const b = document.getElementById(btnCollapseId); if(b) b.innerHTML = '+';
            }
        }
    }
    
    if (saved.order && saved.order.length > 0) {
        AppState.order = saved.order;
        restoreOrder();
    }
}

// --- 4. DATA PROCESSING (GAP FILLING) ---

function fillDataGaps(data) {
    if (!data || data.length < 2) return data;
    const diffs = [];
    for (let i = 1; i < data.length; i++) {
        const d1 = safeDate(data[i-1].date).getTime();
        const d2 = safeDate(data[i].date).getTime();
        const diff = d2 - d1;
        if(diff > 5000 && diff < 86400000) diffs.push(diff);
    }
    if (diffs.length === 0) return data;
    diffs.sort((a,b) => a - b);
    const medianInterval = diffs[Math.floor(diffs.length / 2)];
    if (medianInterval < 30000 || medianInterval > 3600000) return data;

    const filledData = [];
    const threshold = medianInterval * 1.5; 
    
    filledData.push(data[0]);
    for (let i = 1; i < data.length; i++) {
        const prev = filledData[filledData.length - 1];
        const curr = data[i];
        const prevTime = safeDate(prev.date).getTime();
        const currTime = safeDate(curr.date).getTime();
        const diff = currTime - prevTime;

        if (diff > threshold) {
            const gapCount = Math.floor(diff / medianInterval);
            const safeGapCount = Math.min(gapCount, 100); 
            for (let k = 1; k < safeGapCount; k++) {
                const fillTime = new Date(prevTime + (k * medianInterval));
                filledData.push({
                    date: formatDateStr(fillTime),
                    average: 0, median: 0, p95: 0, stddev: 0,
                    messages: 0, rrsets: 0,
                    cache_mb_msg: 0, cache_mb_rr: 0,
                    diff_hits: 0, diff_miss: 0,
                    is_gap: true 
                });
            }
        }
        filledData.push(curr);
    }
    return filledData;
}

function getFilteredData(key) {
    if (!fullHistoryData.length) return [];
    const mode = AppState.charts[key].mode;
    const now = new Date();
    
    let rawData = [];
    if (mode === '12h') rawData = fullHistoryData.filter(d => safeDate(d.date) >= new Date(now - 12 * 3600000));
    else if (mode === '24h') rawData = fullHistoryData.filter(d => safeDate(d.date) >= new Date(now - 24 * 3600000));
    else if (mode === '7d')  rawData = fullHistoryData.filter(d => safeDate(d.date) >= new Date(now - 7 * 86400000));
    else if (mode === '30d') rawData = fullHistoryData.filter(d => safeDate(d.date) >= new Date(now - 30 * 86400000));
    else if (mode === 'cust') {
        const start = new Date(document.getElementById(key + '-start').value);
        const end = new Date(document.getElementById(key + '-end').value);
        if (!isNaN(start) && !isNaN(end)) {
            rawData = fullHistoryData.filter(d => { const t = safeDate(d.date); return t >= start && t <= end; });
        }
    } else {
        rawData = fullHistoryData; 
    }
    return fillDataGaps(rawData);
}

// --- 5. INTERACTION HANDLERS (Generic) ---

function toggleCollapse(id, btn) {
    const el = document.getElementById(id);
    if (el.classList.contains('collapsed')) { el.classList.remove('collapsed'); btn.innerHTML = '&#8722;'; } 
    else { el.classList.add('collapsed'); btn.innerHTML = '+'; }
    saveState();
}

function toggleHeight(id, btn) {
    const el = document.getElementById(id);
    if (el.classList.contains('chart-expanded')) { el.classList.remove('chart-expanded'); btn.classList.remove('active'); } 
    else { el.classList.add('chart-expanded'); btn.classList.add('active'); }
    saveState();
    setTimeout(() => { 
        Object.keys(AppState.charts).forEach(k => {
             if (id.includes(k) || (k==='lat' && id.includes('latency')) || (k==='unb' && id.includes('unbound')) || (k==='eff' && id.includes('efficiency')) || (k==='mem' && id.includes('memory'))) {
                 renderGenericHistory(k);
             }
        });
    }, 350);
}

function toggleLog(key) {
    const cfg = AppState.charts[key];
    cfg.log = !cfg.log;
    document.getElementById(key + '-log-btn').classList.toggle('active');
    saveState();
    if (key === 'dist') renderSnapshotCharts(globalData);
    else renderGenericHistory(key);
}

function toggleChartType(key) {
    const cfg = AppState.charts[key];
    cfg.type = (cfg.type === 'bar') ? 'line' : 'bar';
    const btn = document.getElementById(key + '-type-btn');
    if(btn) btn.innerText = (cfg.type === 'bar') ? 'üìà' : 'üìä';
    saveState();
    renderGenericHistory(key);
}

function toggleScroll(key) {
    const cfg = AppState.charts[key];
    cfg.scroll = !cfg.scroll;
    document.getElementById(key + '-scroll-btn').classList.toggle('active');
    saveState();
    renderGenericHistory(key);
}

function updateFilterButtons(cls, mode) {
    document.querySelectorAll('.' + cls).forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.' + cls + '.f-' + mode).forEach(b => b.classList.add('active'));
}

function updateDistTime(mode) {
    updateTimeFilter('dist', mode);
    
    // --- REMOTE CONTROL START ---
    if (globalData) {
        let source = globalData.latency; // Default Global
        
        // If specific window data exists (from Heavy Math script)
        if (mode === '12h' && globalData.stats_12h) source = globalData.stats_12h;
        else if (mode === '24h' && globalData.stats_24h) source = globalData.stats_24h;
        else if (mode === '7d' && globalData.stats_7d) source = globalData.stats_7d;
        else if (mode === '30d' && globalData.stats_30d) source = globalData.stats_30d;
        
        // Update Big Numbers
        setText('p_avg', (source.average || "--") + " ms");
        setText('p_std', (source.stddev ? source.stddev + " ms" : "--"));
        setText('p_med', (source.median || "--") + " ms");
        setText('p_95', (source.p95 || "--") + " ms");
        
        // Since we calculated Median/P95 in script, we don't need to dim them!
        // Just ensure opacity is full
        const p_med = document.getElementById('p_med'); if(p_med) p_med.style.opacity = '1';
        const p_95 = document.getElementById('p_95'); if(p_95) p_95.style.opacity = '1';

        renderSnapshotCharts(globalData);
    }
    // --- REMOTE CONTROL END ---
}

function updateTimeFilter(key, mode) {
    AppState.charts[key].mode = mode;
    updateFilterButtons('f-' + key, mode);
    
    const custInput = document.getElementById(key + '-custom-inputs');
    if(custInput) custInput.style.display = (mode === 'cust') ? 'flex' : 'none';
    
    if (key === 'dist') {
        if(globalData) renderSnapshotCharts(globalData);
    } else {
        const d = getFilteredData(key);
        checkAutoScroll(key, d);
        renderGenericHistory(key);
    }
    saveState();
}

const updateLatencyTime = (m) => updateTimeFilter('lat', m);
const updateUnboundTime = (m) => updateTimeFilter('unb', m);
const updateSdTime      = (m) => updateTimeFilter('sd', m);
const updateEffTime     = (m) => updateTimeFilter('eff', m);
const updateMemTime     = (m) => updateTimeFilter('mem', m);

const applyLatencyCustom = () => updateTimeFilter('lat', 'cust');
const applyUnboundCustom = () => updateTimeFilter('unb', 'cust');
const applySdCustom      = () => updateTimeFilter('sd', 'cust');
const applyEffCustom     = () => updateTimeFilter('eff', 'cust');
const applyMemCustom     = () => updateTimeFilter('mem', 'cust');

function checkAutoScroll(key, data) {
    if (!data || data.length < 2) return;
    const start = safeDate(data[0].date).getTime();
    const end = safeDate(data[data.length - 1].date).getTime();
    const hours = (end - start) / 3600000;
    const shouldScroll = hours > 48;
    AppState.charts[key].scroll = shouldScroll;
    const btn = document.getElementById(key + '-scroll-btn');
    if(btn) shouldScroll ? btn.classList.add('active') : btn.classList.remove('active');
}

// --- 6. CHART RENDERING ENGINE (DRY) ---

const htmlLegendSplitPlugin = {
    id: 'htmlLegendSplit',
    afterUpdate(chart, args, options) {
        const ul = document.getElementById(options.containerID);
        if (!ul) return;
        while (ul.firstChild) { ul.firstChild.remove(); }
        const items = chart.options.plugins.legend.labels.generateLabels(chart);
        const uniqueItems = items.filter(item => item.datasetIndex < 2);
        uniqueItems.forEach(item => {
            const li = document.createElement('div');
            li.className = `legend-item ${item.hidden ? 'hidden' : ''}`;
            li.onclick = () => { 
                const idx = item.datasetIndex;
                const isVisible = chart.isDatasetVisible(idx);
                chart.setDatasetVisibility(idx, !isVisible);
                if (chart.data.datasets[idx + 2]) chart.setDatasetVisibility(idx + 2, !isVisible);
                chart.update(); 
            };
            const box = document.createElement('div');
            box.className = 'legend-box';
            box.style.borderColor = item.fillStyle;
            if (!item.hidden) box.style.backgroundColor = item.fillStyle; 
            li.append(box, Object.assign(document.createElement('span'), {innerText: item.text}));
            ul.appendChild(li);
        });
    }
};

function generateSplitBarDatasets(dataA, dataB, labelA, labelB, colorA, colorB) {
    const backA = [], frontA = [], backB = [], frontB = [];
    for(let i=0; i<dataA.length; i++) {
        let vA = (dataA[i]===null) ? null : Number(dataA[i]);
        let vB = (dataB[i]===null) ? null : Number(dataB[i]);
        if (vA !== null && vB !== null && vA >= vB) {
            backA.push(vA); frontA.push(null); backB.push(null); frontB.push(vB);
        } else {
            backA.push(null); frontA.push(vA); backB.push(vB); frontB.push(null);
        }
    }
    const common = { type: 'bar', grouped: false, barPercentage: 0.6, categoryPercentage: 0.8, yAxisID: 'y' };
    return [
        { ...common, label: labelA, data: backA, backgroundColor: colorA, order: 2 },
        { ...common, label: labelB, data: backB, backgroundColor: colorB, order: 2 },
        { ...common, label: labelA, data: frontA, backgroundColor: colorA, order: 1 },
        { ...common, label: labelB, data: frontB, backgroundColor: colorB, order: 1 }
    ];
}

function renderGenericHistory(key) {
    if (!fullHistoryData.length) return;
    
    const cfg = AppState.charts[key];
    const data = getFilteredData(key);
    const labels = data.map(d => d.date.substring(5, 16) || ""); 
    const palette = getThemePalette();

    let dsA, dsB, lblA, lblB, colA, colB, suggestedMax;
    
    // Data mapping logic
    if (key === 'lat') {
        dsA = data.map(d => d.average); lblA = "Average"; colA = palette.avg;
        dsB = data.map(d => d.p95);     lblB = "P95";     colB = palette.p95;
        suggestedMax = Math.max(...dsB.filter(v=>v!==null), 0) * 1.2;
    } 
    else if (key === 'unb') {
        dsA = data.map(d => d.messages); lblA = "Msg";   colA = palette.msg;
        dsB = data.map(d => d.rrsets);   lblB = "RRset"; colB = palette.rr;
        suggestedMax = Math.max(...dsA.filter(v=>v!==null), ...dsB.filter(v=>v!==null), 0) * 1.2;
    }
    else if (key === 'mem') {
        dsA = data.map(d => d.cache_mb_msg); lblA = "Msg MB";   colA = palette.mem_msg;
        dsB = data.map(d => d.cache_mb_rr);  lblB = "RRset MB"; colB = palette.mem_rr;
        suggestedMax = Math.max(...dsA.filter(v=>v!==null), ...dsB.filter(v=>v!==null), 0) * 1.2;
    }
    else if (key === 'eff') {
        dsA = data.map(d => d.diff_hits); lblA = "Hits";   colA = palette.diff_hit;
        dsB = data.map(d => d.diff_miss); lblB = "Misses"; colB = palette.diff_miss;
        suggestedMax = Math.max(...dsA.filter(v=>v!==null), ...dsB.filter(v=>v!==null), 0) * 1.1;
    }
    else if (key === 'sd') {
        dsA = data.map(d => d.average); lblA = "Average"; colA = palette.sd_avg;
        dsB = data.map(d => d.stddev);  lblB = "Std Dev"; colB = palette.sd_val;
        suggestedMax = Math.max(...dsA.filter(v=>v!==null), ...dsB.filter(v=>v!==null), 0) * 1.2;
    }

    if (labels.length < 12) {
        const diff = 12 - labels.length;
        for(let i=0; i<diff; i++) { labels.unshift(""); dsA.unshift(null); dsB.unshift(null); }
    }

    let datasets = [];
    if (cfg.type === 'line') {
        // FIX 2: Set backgroundColor to the actual color (instead of transparent) so the tooltip box is filled.
        // We keep 'fill: false' so the line chart itself doesn't fill the area.
        const commonLine = { type: 'line', borderWidth: CHART_LINE_THICKNESS, pointRadius: 0, fill: false, yAxisID: 'y' };
        datasets = [
            { ...commonLine, label: lblA, data: dsA, borderColor: colA, backgroundColor: colA },
            { ...commonLine, label: lblB, data: dsB, borderColor: colB, backgroundColor: colB }
        ];
    } else {
        datasets = generateSplitBarDatasets(dsA, dsB, lblA, lblB, colA, colB);
    }

    const styles = getComputedStyle(document.documentElement);
    const gridC = styles.getPropertyValue('--chart-grid').trim();
    const textC = styles.getPropertyValue('--chart-text').trim();
    const ctx = document.getElementById(cfg.ctxId).getContext('2d');
    const yType = cfg.log ? 'logarithmic' : 'linear';

    const containerName = cfg.ctxId === 'historyChart' ? 'latency' : cfg.ctxId.replace('Chart',''); 
    const container = document.getElementById(`${containerName}-chart-container`);
    const winDiv = document.getElementById(`${containerName}-scroll-window`);
    
    if (container && winDiv) {
        if (cfg.scroll && labels.length > 0) {
            const width = Math.min(Math.max(winDiv.clientWidth, labels.length * (labels.length > 3000 ? 4 : 9)), 32000) + 'px';
            container.style.width = width;
            setTimeout(() => { winDiv.scrollLeft = winDiv.scrollWidth; }, 50);
        } else {
            container.style.width = '100%';
        }
    }

    const chartOpts = {
        responsive: true, maintainAspectRatio: false, normalized: true, spanGaps: true,
        animation: (isFirstLoad && labels.length < 500) ? {} : false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { 
                display: false, 
                labels: { generateLabels: (chart) => [
                    { text: lblA, fillStyle: colA, hidden: !chart.isDatasetVisible(0) && !chart.isDatasetVisible(2), datasetIndex: 0 },
                    { text: lblB, fillStyle: colB, hidden: !chart.isDatasetVisible(1) && !chart.isDatasetVisible(3), datasetIndex: 1 }
                ]}
            },
            htmlLegendSplit: { containerID: cfg.legendId },
            tooltip: { 
                enabled: true, 
                backgroundColor: 'rgba(0,0,0,0.8)', 
                filter: (item) => item.raw !== null,
                // FIX 1: Custom Callback for Percentage
                callbacks: {
                    label: (context) => {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        if (context.parsed.y !== null) label += formatK(context.parsed.y);
                        
                        // Percentage Logic for Efficiency Chart
                        if (key === 'eff') {
                            const d = data[context.dataIndex]; // Get raw data object
                            if(d) {
                                const total = (d.diff_hits || 0) + (d.diff_miss || 0);
                                if(total > 0) {
                                    // Calculate % based on value vs total queries
                                    const pct = ((context.parsed.y / total) * 100).toFixed(1);
                                    label += ` (${pct}%)`;
                                }
                            }
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: { ticks: { color: textC, maxTicksLimit: cfg.scroll ? Math.floor(parseInt(container.style.width)/60) : 12 }, grid: { display: false } },
            y: { type: yType, grid: { color: gridC }, ticks: { color: textC, callback: (v) => formatK(v) }, suggestedMax: cfg.log ? undefined : suggestedMax, beginAtZero: !cfg.log }
        }
    };

    if (cfg.instance) {
        if (cfg.instance.config.type !== cfg.type) { cfg.instance.destroy(); cfg.instance = new Chart(ctx, { type: cfg.type, data: { labels, datasets }, options: chartOpts, plugins: [htmlLegendSplitPlugin] }); }
        else {
            cfg.instance.data.labels = labels;
            cfg.instance.data.datasets = datasets;
            cfg.instance.options = chartOpts;
            cfg.instance.update();
            htmlLegendSplitPlugin.afterUpdate(cfg.instance, null, { containerID: cfg.legendId });
        }
    } else {
        cfg.instance = new Chart(ctx, { type: cfg.type, data: { labels, datasets }, options: chartOpts, plugins: [htmlLegendSplitPlugin] });
    }
}
function renderSnapshotCharts(data) {
    if(!data) return;
    const cfg = AppState.charts.dist;
    
    // FIX: Always grab LABELS from the master definitions
    const masterTiers = data.tiers || [];
    const rawCounts = cfg.mode === '12h' ? data.tiers_12h : cfg.mode === '24h' ? data.tiers_24h : cfg.mode === '7d' ? data.tiers_7d : cfg.mode === '30d' ? data.tiers_30d : data.tiers;
    
    const sourceData = rawCounts || masterTiers;
    
    let plotData = [], labels = [];
    
    if(sourceData) {
        sourceData.forEach((item, i) => { 
            const val = Number(item.count || (item.value ? item.value : item)); 
            
            if(val > 0) { 
                plotData.push(val); 
                
                let labelText = "T" + (i+1);
                
                if (masterTiers[i] && masterTiers[i].label) {
                    labelText = masterTiers[i].label.replace("Tier ", "T");
                } else if (item.label) {
                    labelText = item.label.replace("Tier ", "T");
                }
                
                labels.push(labelText); 
            }
        });
    }

    const palette = generateVibrantColors(labels.length);
    const styles = getComputedStyle(document.documentElement);
    const textC = styles.getPropertyValue('--chart-text').trim();
    const gridC = styles.getPropertyValue('--chart-grid').trim();

    const floor = Math.max(0.1, (Math.min(...plotData) || 1) * 0.9);
    const finalData = plotData.map(v => (cfg.log && v < floor) ? floor : v);
    
    const chartData = { labels, datasets: [{ label: 'Queries', data: finalData, backgroundColor: palette.bg, borderColor: palette.border, borderWidth: 1, borderRadius: 3 }] };
    
    if (cfg.instance) cfg.instance.destroy();
    cfg.instance = new Chart(document.getElementById('latencyChart'), {
        type: 'bar', data: chartData,
        options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            layout: { padding: { top: 20 } },
            scales: {
                y: { type: cfg.log ? 'logarithmic' : 'linear', min: cfg.log ? floor : 0, grid: { color: gridC }, ticks: { color: textC, callback: (v) => (v <= floor && cfg.log) ? '' : formatK(v) } },
                x: { grid: { display: false }, ticks: { color: textC } }
            },
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => c.dataset.label + ': ' + plotData[c.dataIndex] } } }
        },
        plugins: [{
            id: 'topLabels',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((ds, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((bar, idx) => {
                        ctx.fillStyle = textC; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
                        let y = bar.y - 5; if(y > chart.chartArea.bottom) y = chart.chartArea.bottom - 5;
                        ctx.fillText(formatK(plotData[idx]), bar.x, y);
                    });
                });
            }
        }]
    });
}

function generateVibrantColors(count) {
    const theme = AppState.theme;
    const colors = [], borders = [];
    const sat = (theme==='contrast') ? 100 : (theme==='light') ? 70 : 75;
    const lit = (theme==='contrast') ? 50 : (theme==='light') ? 40 : 60;
    for (let i = 0; i < count; i++) {
        const h = (Math.floor((360 / count) * i) + 200) % 360;
        colors.push(`hsla(${h}, ${sat}%, ${lit}%, 1)`);
        borders.push(`hsla(${h}, ${sat}%, ${lit}%, 1)`);
    }
    return { bg: colors, border: borders };
}

function applyTheme(theme) {
    AppState.theme = theme;
    if (theme === 'dark') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('phls_theme', theme);
    
    if (globalData) renderSnapshotCharts(globalData);
    if (fullHistoryData.length) {
        ['lat','unb','eff','mem','sd'].forEach(k => renderGenericHistory(k));
    }
}

// --- 7. MAIN FETCH LOOP ---

async function checkForUpdates(scriptCurrent) {
    try {
        const resp = await fetch('version?t=' + Date.now());
        const remoteText = await resp.text();
        const getV = (r, regex) => (r.match(regex) || [])[1];
        const remS = getV(remoteText, /s=([0-9.]+)/);
        const remD = getV(remoteText, /d=([0-9.]+)/);

        // --- FIXED COMPARISON LOGIC ---
        const isNewer = (rem, cur) => {
            if (!rem || !cur) return false;
            // Strip 'v' and split
            const r = rem.replace(/[^0-9.]/g, '').split('.').map(Number);
            const c = cur.replace(/[^0-9.]/g, '').split('.').map(Number);
            
            // Compare digit by digit
            for (let i = 0; i < Math.max(r.length, c.length); i++) {
                const rv = r[i] || 0;
                const cv = c[i] || 0;
                if (rv > cv) return true;  // Remote is larger
                if (rv < cv) return false; // Remote is smaller (stop checking)
            }
            return false; // Exactly equal
        };

        const link = ' <a href="https://panoc.github.io/pihole-latency-stats/" target="_blank" class="new-version-link">';
        
        if (remS && isNewer(remS, scriptCurrent)) {
            document.getElementById('script-new-v').innerHTML = link + `(NEW ${remS})</a>`;
        }
        if (remD && isNewer(remD, currentDashVersion)) {
            document.getElementById('dash-new-v').innerHTML = link + `(NEW ${remD})</a>`;
        }
    } catch (e) { console.warn("Update check skipped", e); }
}

async function fetchData() {
    try {
        const params = new URLSearchParams(window.location.search);
        const profile = params.get('p') || 'default';
        setText('profile-indicator', profile.toUpperCase());
        
        const resp = await fetch(`dash_${profile}.json?t=` + Date.now());
        if (!resp.ok) throw new Error("Snapshot file missing");
        const data = await resp.json();
        
        globalData = data;
        fetchFailCount = 0;
        refreshSeconds = 60;
        
        setText('header_date', "Last Analysis: " + data.date);
        setText('time_period', data.time_period || "All Time");
        setText('query_mode', data.mode || "Normal");
        setText('script-v-num', data.version || "Unknown");
        setText('dash-v-num', currentDashVersion);
        
        if (!updateChecked) { checkForUpdates(data.version || "0.0.0"); updateChecked = true; }

        const s = data.stats, l = data.latency, u = data.unbound;
        setText('p_total', s.total_queries);
        setText('p_invalid', s.unsuccessful); setText('p_invalid_pct', calcPct(s.unsuccessful, s.total_queries));
        setText('p_valid', s.total_valid);
        setText('p_blocked', (Number(s.blocked)+Number(s.ignored)) + " / " + s.ignored);
        setText('p_blocked_pct', calcPct(Number(s.blocked)+Number(s.ignored), s.total_queries));
        setText('p_analyzed', s.analyzed); setText('p_analyzed_pct', calcPct(s.analyzed, s.total_queries));
        
        setText('p_avg', l.average + " ms");
        setText('p_std', (l.stddev ? l.stddev + " ms" : "--"));
        setText('p_med', l.median + " ms"); setText('p_95', l.p95 + " ms");

        if (u) {
            const isActive = u.status && u.status.toLowerCase().includes('active');
            const badg = document.getElementById('u_status_badge');
            badg.innerText = isActive ? "Active" : "Issue / Check"; badg.className = "badge " + (isActive ? "bg-success" : "bg-danger");
            
            setText('u_total', Number(u.total_hits)+Number(u.total_miss));
            setText('u_hits', u.total_hits); setText('u_hit_pct', `(${u.ratio}%)`);
            setText('u_miss', u.total_miss); setText('u_miss_pct', `(${(100-parseFloat(u.ratio)).toFixed(2)}%)`);
            setText('u_pre', u.prefetch); setText('u_pre_pct', calcPct(u.prefetch, u.total_hits) + " of Hits");
            
            if(u.memory && u.memory.msg) {
                setText('mem_msg_txt', `${u.memory.msg.used_mb}MB / ${u.memory.msg.limit_mb}MB (${u.memory.msg.percent}%)`);
                document.getElementById('mem_msg_bar').style.width = u.memory.msg.percent + "%";
                setText('mem_rr_txt', `${u.memory.rrset.used_mb}MB / ${u.memory.rrset.limit_mb}MB (${u.memory.rrset.percent}%)`);
                document.getElementById('mem_rr_bar').style.width = u.memory.rrset.percent + "%";
            }
            if(u.cache_count) { setText('ucc_msg', u.cache_count.messages); setText('ucc_rr', u.cache_count.rrsets); }
        }
        
        renderSnapshotCharts(data);

        const hResp = await fetch(`dash_${profile}.h.json?t=` + Date.now());
        if (hResp.ok) {
            fullHistoryData = await hResp.json();
            if (fullHistoryData.length > 5) {
                const sample = fullHistoryData.slice(-30);
                const ints = [];
                for(let i=1; i<sample.length; i++) ints.push((safeDate(sample[i].date)-safeDate(sample[i-1].date))/60000);
                ints.sort((a,b)=>a-b);
                const med = ints[Math.floor(ints.length/2)];
                const diff = (Date.now() - safeDate(data.date).getTime())/60000;
                if (diff > Math.max(med*3, 5)) document.getElementById('header_date').innerHTML = `‚ö†Ô∏è <span style="color:var(--acc-red); font-weight:bold;">DATA STALE: (Last run: ${Math.round(diff)} mins ago)</span>`;
            }

            ['lat','unb','eff','mem','sd'].forEach(k => renderGenericHistory(k));
            isFirstLoad = false;
        }

    } catch (err) {
        console.error(err);
        fetchFailCount++;
        const el = document.getElementById('header_date');
        if(fetchFailCount >= 3) el.innerHTML = `‚õî <span style="color:var(--acc-red);">CONNECTION LOST (x${fetchFailCount})</span>`;
        else el.innerHTML = `<span style="color:var(--acc-yellow);">Connection Issue... Retrying</span>`;
    }
}

function updateTimerDisplay() { document.getElementById('refreshTimer').innerText = "Auto-refresh in " + refreshSeconds + "s"; }
setInterval(() => { refreshSeconds--; if (refreshSeconds <= 0) fetchData(); else updateTimerDisplay(); }, 1000);

// Init
loadState();
fetchData();

</script>
</body>
</html>
